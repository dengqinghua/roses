"use strict";var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}if("undefined"!=typeof module&&"undefined"!=typeof module.exports)var window=require("svgdom"),document=window.document,Tonal=require("tonal"),debug=require("debug")("app:chordy-svg"),SVG=require("svg.js")(window);else{if("undefined"==typeof window.Tonal)throw new Error("Tonal not loaded");if("undefined"==typeof window.SVG)throw new Error("SVG.js not loaded")}var chordySvg=function(){function a(b,c){_classCallCheck(this,a),this.config={stringCount:6,fretCount:5,fretLength:30,stringPitch:30,stringWidth:1,dotDiameter:25,fontSizeDot:11,fontSizeX:22,fontSizeFretNumber:16,fontSizeTitle:22,stringIntervals:[0,5,10,15,19,24],stringLowest:"E2",display:"interval",offset:{x:50,y:50},colorRootBackground:"#c00",fontDir:"",fontFamilyMappings:{},target:{}},Object.assign(this.config,c),""===this.config.fontDir||this.isEmpty(this.config.fontFamilyMappings)||(window.setFontDir(this.config.fontDir),window.setFontFamilyMappings(this.config.fontFamilyMappings),window.preloadFonts()),this.svgConfig={fontSizeMultiplier:1.25,offsetX:this.config.fontSizeX,offsetY:this.config.fontSizeX+1.25*this.config.fontSizeTitle,height:this.config.fretCount*this.config.fretLength+this.config.fontSizeX+this.config.fontSizeTitle+20,width:this.config.stringCount*(this.config.stringPitch-1)+50},this.chord={name:b.name,shape:b.shape,comment:b.comment,containsOpen:!1,containsMute:!1,fretted:[],stringsOpen:[],stringsMute:[],root:b.root,string:[],semitones:[],notes:[]},this.processChord(b);this.svgChord="undefined"!=typeof module&&"undefined"!=typeof module.exports?SVG(document.documentElement).size(this.svgConfig.width,this.svgConfig.height):SVG(this.config.target).size(this.svgConfig.width,this.svgConfig.height),this.svgChord.clear(),this.svgChord.defs().element("style").words("");var d=this.svgChord.defs().attr("id","tonal");d.element("notes").attr("id","tonal-notes").words(this.chord.notes.join(":")),d.element("semitones").attr("id","tonal-semitones").words(this.chord.semitones.join(":")),d.element("comment").attr("id","chord-comment").words(this.chord.comment);var e=this.svgChord.group();e.attr("id","master");var f=e.group();f.attr("id","grid"),this.drawStrings(f);var g=e.group();g.attr("id","X"),this.drawX(g,b);var h=e.group();h.attr("id","dots"),this.drawDots(h);var i=e.group();i.attr("id","title"),this.drawTitle(i),e.move(this.svgConfig.offsetX,this.svgConfig.offsetY),this.svgData=this.svgChord.svg()}var b=Number.isNaN;return _createClass(a,[{key:"svg",value:function(){return this.svgData}},{key:"notes",value:function(){return this.chord.notes}},{key:"processChord",value:function(a){for(var c,d=Tonal.Note.midi(this.config.stringLowest),e=[],f=0;f<a.shape.length;f++)if(c=parseInt(a.shape[f],16),b(c)){if("x"===a.shape[f]||"X"===a.shape[f])this.chord.containsMute=!0,this.chord.stringsMute.push(f),e[f]="x";else throw new Error("Invalid shape: "+a.shape);}else if(0===c){this.chord.containsOpen=!0,this.chord.stringsOpen.push(f);var g=this.config.stringIntervals[f];this.chord.semitones.push(g),this.chord.notes.push(Tonal.Note.fromMidi(d+g)),e[f]=c}else{this.chord.fretted.push(c);var h=this.config.stringIntervals[f]+c;this.chord.semitones.push(h),this.chord.notes.push(Tonal.Note.fromMidi(d+h)),e[f]=c}this.chord.minFret=Math.min.apply(Math,_toConsumableArray(this.chord.fretted)),this.chord.maxFret=Math.max.apply(Math,_toConsumableArray(this.chord.fretted)),this.chord.shape=e}},{key:"drawStrings",value:function(a){for(var b=this.config.fretCount*this.config.fretLength,c=0;c<this.config.stringCount;c++)a.line(0,0,0,b).stroke({width:1}).attr("id","string-"+c).move(c*this.config.stringPitch,0);for(var d=this.config.stringPitch*(this.config.stringCount-1),e=0;e<=this.config.fretCount;e++)a.line(0,0,d,0).stroke({width:1}).attr("id","fret-"+e).move(0,e*this.config.fretLength);return this}},{key:"drawX",value:function(a,b){for(var c=0;c<this.config.stringCount;c++)("X"===b.shape[c]||"x"===b.shape[c])&&a.text("X").attr("id","x-"+c).font({anchor:"middle",size:this.config.fontSizeX}).fill({color:"#000"}).move(c*this.config.stringPitch,-this.config.fontSizeX*this.svgConfig.fontSizeMultiplier),"0"===b.shape[c]&&a.text("O").attr("id","o-"+c).font({anchor:"middle",size:this.config.fontSizeX}).fill({color:"#000"}).move(c*this.config.stringPitch,-this.config.fontSizeX*this.svgConfig.fontSizeMultiplier)}},{key:"drawDots",value:function(a){var c={dot:{x:-this.config.dotDiameter/2,y:-(this.config.dotDiameter/2)+this.config.fretLength/2},text:{x:0,y:-this.config.fontSizeDot/2*this.svgConfig.fontSizeMultiplier}},d=this.config.stringIntervals[this.chord.root-1]+parseInt(this.chord.shape[this.chord.root-1],10);if(b(d))throw new Error("Root position "+this.chord.root+" has no integer in shape '"+this.chord.shape.join("")+"'");var e=5>=this.chord.minFret&&5>=this.chord.maxFret?1:this.chord.minFret;for(var f,g=0;g<this.config.stringCount;g++){f=-d+1+this.config.stringIntervals[g]+e-1;for(var h=0;h<this.config.fretCount;h++){var i=h+e,j=Tonal.Interval.fromSemitones(f),k=Tonal.Interval.fromSemitones(f%12),l=Tonal.Note.names(" b"),m=l[(f+144)%12];if(f++,parseInt(this.chord.shape[g],10)===h+e){var n=a.group();n.attr("id","dot-"+g+"-"+h);var o=c.dot.x+g*this.config.stringPitch,p=c.dot.y+h*this.config.fretLength;n.circle(this.config.dotDiameter).attr("id","circle-"+g+"-"+h).move(o,p),o=c.text.x+g*this.config.stringPitch,p=c.text.y+h*this.config.fretLength+this.config.fretLength/2;var q=n.text(k).addClass("interval").attr("id","circle-"+g+"-"+h+"-interval").fill({color:"#fff"}).font({anchor:"middle",size:this.config.fontSizeDot}).move(o,p).hide();this.chord.root-1===g&&(n.select("circle").addClass("dot-root").fill({color:this.config.colorRootBackground}),a.text(i+" fr").attr("id","fret-number").fill({color:"#f00"}).font({anchor:"left",size:this.config.fontSizeFretNumber}).move((this.config.stringCount-1)*this.config.stringPitch+0.6*this.config.dotDiameter,p)),n.show(),"interval"===this.config.display&&q.show(),a.add(n)}}}-1!==this.chord.stringsOpen.indexOf(this.chord.root-1)&&a.text(e+" fr").attr("id","fret-number").fill({color:"#f00"}).font({anchor:"left",size:this.config.fontSizeFretNumber}).move((this.config.stringCount-1)*this.config.stringPitch+0.6*this.config.dotDiameter,1)}},{key:"drawTitle",value:function(a){a.text(this.chord.name).attr("id","title").font({anchor:"left",size:this.config.fontSizeTitle}).fill({color:"#000"}).move(0,-(this.config.fontSizeX+this.config.fontSizeTitle)*this.svgConfig.fontSizeMultiplier)}},{key:"isEmpty",value:function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}}]),a}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=chordySvg:window.ChordySvg=chordySvg;