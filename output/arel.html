<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="baidu-site-verification" content="N1Q3HiESgp" />

<title>Arel Inspection — dengqinghua&#39;s blog</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
  <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shCore.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shThemeRailsGuides.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/fixes.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/abcjs-midi.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/gitalk.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/Treant.css" />
  <link href="images/favicon.jpeg" rel="shortcut icon" type="image/x-icon" />
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="guide">
  <div id="topNav">
    <div class="wrapper">

      <strong class="more-info-label">More:</strong>

      <span class="red-button more-info-button">More Dengqinghua</span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://dengqinghua.github.io/about_me.html">About me</a></li>
        <li class="more-info"><a href="https://github.com/dengqinghua/">Github</a></li>
        <li class="more-info"><a href="mailto:dengqinghua.42@gmail.com">Gmail</a></li>
        <li class="more-info"><a href="https://twitter.com/dengqinghua_42">Twitter</a></li>
      </ul>

      <form action="https://google.com/search" method="get">
          <input name="q" value="site:dengqinghua.github.io" type="hidden">
          <input class="search" name="q" placeholder="Search Blog" type="text">
      </form>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="http://dengqinghua.github.io" title="Return to home page">http://dengqinghua.github.io</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="http://dengqinghua.github.io">Home</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">
            Index <span id="guidesArrow">▸</span>
          </a>

          <div id="guides" class="clearfix" style="display: none;">
            <hr />
              <dl class="L">
                <dt>推荐</dt>
                <dd><a href="badge_system.html">基于内存数据库的角标系统设计</a></dd>
                <dd><a href="witness_flow.html">业务流引擎系统</a></dd>
                <dt>Ruby</dt>
                <dd><a href="ruby_knowledge_tree.html">Ruby知识树</a></dd>
                <dd><a href="ruby_model.html">Ruby数据模型</a></dd>
                <dd><a href="arel.html?lang=en">Arel源码分析</a></dd>
                <dd><a href="sidekiq_task_event.html">基于Sidekiq的异步任务管理引擎</a></dd>
                <dd><a href="racc.html">Racc</a></dd>
                <dd><a href="witness_flow.html">业务流引擎系统</a></dd>
                <dt>Java</dt>
                <dd><a href="data_structures.html">数据结构</a></dd>
                <dd><a href="learn_jvm.html">JVM剖析</a></dd>
                <dd><a href="concurrency.html">Concurrency</a></dd>
                <dd><a href="badge_system.html">基于内存数据库的角标系统设计</a></dd>
                <dd><a href="maven_under_command_line.html">命令行下的Maven</a></dd>
                <dt>MySQL</dt>
                <dd><a href="mysql_knowledge_tree.html">MySQL知识树</a></dd>
              </dl>
              <dl class="R">
                <dt>Go</dt>
                <dd><a href="go_get_timeout_solution.html">GoInstallBinaries i/o timeout问题</a></dd>
                <dd><a href="go_knowledge_tree.html">Go知识树</a></dd>
                <dt>音乐</dt>
                <dd><a href="music_index.html">音乐学习体系</a></dd>
                <dd><a href="lalaland-city_of_stars.html">City Of Star</a></dd>
                <dd><a href="あの日の帰り道.html">あの日の帰り道</a></dd>
                <dd><a href="rain_wwh.html">雨の日はワルツを踊って</a></dd>
                <dd><a href="moon_river.html">Moon River</a></dd>
                <dd><a href="it_could_have_been.html">Es Ware Schon Gewesen</a></dd>
                <dt>杂记</dt>
                <dd><a href="example_markdown.html">markdown格式实例</a></dd>
                <dd><a href="comments.html">注释规范</a></dd>
                <dd><a href="best_programming.html">零bug落地方案</a></dd>
                <dd><a href="raft.html">Raft算法</a></dd>
                <dd><a href="memorize_my_mentor.html">Memorize My Mentor</a></dd>
              </dl>
          </div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Index</option>
              <optgroup label="推荐">
                  <option value="badge_system.html">基于内存数据库的角标系统设计</option>
                  <option value="witness_flow.html">业务流引擎系统</option>
              </optgroup>
              <optgroup label="Ruby">
                  <option value="ruby_knowledge_tree.html">Ruby知识树</option>
                  <option value="ruby_model.html">Ruby数据模型</option>
                  <option value="arel.html?lang=en">Arel源码分析</option>
                  <option value="sidekiq_task_event.html">基于Sidekiq的异步任务管理引擎</option>
                  <option value="racc.html">Racc</option>
                  <option value="witness_flow.html">业务流引擎系统</option>
              </optgroup>
              <optgroup label="Java">
                  <option value="data_structures.html">数据结构</option>
                  <option value="learn_jvm.html">JVM剖析</option>
                  <option value="concurrency.html">Concurrency</option>
                  <option value="badge_system.html">基于内存数据库的角标系统设计</option>
                  <option value="maven_under_command_line.html">命令行下的Maven</option>
              </optgroup>
              <optgroup label="MySQL">
                  <option value="mysql_knowledge_tree.html">MySQL知识树</option>
              </optgroup>
              <optgroup label="Go">
                  <option value="go_get_timeout_solution.html">GoInstallBinaries i/o timeout问题</option>
                  <option value="go_knowledge_tree.html">Go知识树</option>
              </optgroup>
              <optgroup label="音乐">
                  <option value="music_index.html">音乐学习体系</option>
                  <option value="lalaland-city_of_stars.html">City Of Star</option>
                  <option value="あの日の帰り道.html">あの日の帰り道</option>
                  <option value="rain_wwh.html">雨の日はワルツを踊って</option>
                  <option value="moon_river.html">Moon River</option>
                  <option value="it_could_have_been.html">Es Ware Schon Gewesen</option>
              </optgroup>
              <optgroup label="杂记">
                  <option value="example_markdown.html">markdown格式实例</option>
                  <option value="comments.html">注释规范</option>
                  <option value="best_programming.html">零bug落地方案</option>
                  <option value="raft.html">Raft算法</option>
                  <option value="memorize_my_mentor.html">Memorize My Mentor</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Arel Inspection</h2><div class="date"><p>2015-07-15</p></div><p>This guide covers basic understanding of the Arel gem.</p><p>After reading this guide, you will know:</p>
<ul>
<li>How to use Arel to generate SQL string.</li>
<li>How the Arel works in perspection of its source code.</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#what-is-arel-questionmark">What is Arel?</a></li>
<li><a href="#generate-sql-string-with-arel">Generate SQL string with Arel</a></li>
<li>
<a href="#the-arel-sql-mapping">The Arel-SQL mapping</a>

<ul>
<li><a href="#abstract-syntax-tree">Abstract Syntax Tree</a></li>
<li><a href="#sql-design-pattern">SQL Design Pattern</a></li>
<li><a href="#arel-design-pattern">Arel Design Pattern</a></li>
</ul>
</li>
<li><a href="#arel-source-code-inspection">Arel Source Code Inspection</a></li>
<li><a href="#is-there-a-simple-way-to-create-sql-strings-questionmark">Is there a simple way to create SQL strings?</a></li>
<li><a href="#what-s-more-about-arel">What's more about Arel</a></li>
<li><a href="#reference">Reference</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <div class="note"><p>This artical is inspired and collected by this <a href="http://railscasts-china.com/episodes/kenshin54-source-code-analysis-arel">video</a>. Thanks to <a href="https://github.com/kenshin54">kenshin54</a>.</p></div><h3 id="what-is-arel-questionmark"><a class="anchorlink" href="#what-is-arel-questionmark">1 What is Arel?</a></h3><p><a href="https://github.com/rails/arel">Arel</a> is a SQL.
<a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a>
manager for Ruby. It</p>
<ol>
<li>Simplifies the generation of complex SQL queries</li>
<li>Adapts to various RDBMSes</li>
</ol>
<div class="info"><p>Arel might be a short for ActiveRelation</p></div><h3 id="generate-sql-string-with-arel"><a class="anchorlink" href="#generate-sql-string-with-arel">2 Generate SQL string with Arel</a></h3><p>The method <code>Arel::Nodes::Node#to_sql</code> could generate SQL string.</p><div class="note"><p>The gem <code>active_record</code> has required Arel gem, and the bind between
Arel and active_record is very close, because Arel needs a <code>engine</code> to work,
which is very confused to me.</p></div><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
require 'active_record'

ActiveRecord::Base.establish_connection(
  adapter:  'mysql2',
  database: 'test',
  host:     'localhost',
  username: 'root',
  password: '1024'
)

user = Arel::Table.new('users')
arel = user.
  project('id', 'user_name').        # select
  where(user[:nick_name].eq('dsg')). # where
  order('created_at DESC').          # order
  skip(10).                          # offset
  take(5);                           # limit

sql = arel.to_sql
#=&gt;
# SELECT  id, user_name FROM `users`
#   WHERE `user`.`nick_name` = 'dsg'
#   ORDER BY created_at DESC
#   LIMIT 5
#   OFFSET 10

</pre>
</div>
<p>When we get the sql, we can use <code>ActiveRecord::Base.find_by_sql(sql)</code> to get
the record.</p><div class="warning"><p>An ActiveRecord::Base.connection is needed here, but the generating-sql
progress is no business of the connecion.</p></div><p>Another example usage of Arel in Rails.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
#
#  SELECT `roles`.` FROM `roles`
#     WHERE(
#       `roles`.`id` &lt; 10
#          AND `roles`.`id` &gt; 0
#          OR  `roles`.`id` = 1024
#     )

t = Role.arel_table
Role.where(
  t[:id].
    lt(10).
    and(t[:id].gt 0).
    or(t[:id].eq 1024)
)

</pre>
</div>
<h3 id="the-arel-sql-mapping"><a class="anchorlink" href="#the-arel-sql-mapping">3 The Arel-SQL mapping</a></h3><p>To know the Arel-SQL mapping, we should first know two concepts:</p>
<ul>
<li>Abstract Syntax Tree</li>
<li>SQL Design Pattern</li>
</ul>
<h4 id="abstract-syntax-tree"><a class="anchorlink" href="#abstract-syntax-tree">3.1 Abstract Syntax Tree</a></h4><p>Abstract Syntax Tree is a tree representation of the abstract syntactic
structure of source code written in a programming language.</p><p>An example of AST can be as below:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
while b!=0 do
  if a &gt; b
    a = a - b
  else
    b = b - a
  end
end

return a

</pre>
</div>
<p><img src="https://raw.githubusercontent.com/dengqinghua/roses/master/assets/images/AST.png" alt="AST"></p><h4 id="sql-design-pattern"><a class="anchorlink" href="#sql-design-pattern">3.2 SQL Design Pattern</a></h4><p>Take the <code>SELECT</code> part as an example:</p><div class="info"><p>The design comes from <a href="https://www.sqlite.org/lang_select.html">SQL As Understood By SQLite</a></p></div>
<ul>
<li>select_statement</li>
</ul>
<p>  <img src="https://raw.githubusercontent.com/dengqinghua/roses/master/assets/images/factored-select-stmt.gif" alt="select-stmt"></p>
<ul>
<li>select_core</li>
</ul>
<p>  <img src="https://raw.githubusercontent.com/dengqinghua/roses/master/assets/images/select-core.gif" alt="select-core"></p><p>The <code>SELECT</code> part can be seen as below:</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: true;">
|-- SelectCore
|   |-- Projections(id, user_name, ...)
|   |-- Where
|   |-- Group
|-- Order
|-- Limit
|-- Limit
|-- Offset

</pre>
</div>
<h4 id="arel-design-pattern"><a class="anchorlink" href="#arel-design-pattern">3.3 Arel Design Pattern</a></h4><p>Come back to the sql</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
user = Arel::Table.new('users')
arel = user.
  project('id', 'user_name').        # select
  where(user[:nick_name].eq('dsg')). # where
  order('created_at DESC').          # order
  skip(10).                          # offset
  take(5);                           # limit

</pre>
</div>
<p>We can get the sql</p><div class="code_container">
<pre class="brush: sql; gutter: false; toolbar: true;">
  SELECT  id, user_name FROM `users`
    WHERE `user`.`nick_name` = 'dsg'
    ORDER BY created_at DESC
    LIMIT 5
    OFFSET 10

</pre>
</div>
<p>Arel gives a method to draw an AST image.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
File.write('arel.dot', arel.to_dot)
system %x(dot arel.dot -T png -o arel.png)

</pre>
</div>
<p>Then we get the map of Arel</p><p>  <img src="https://raw.githubusercontent.com/dengqinghua/roses/master/assets/images/arel.png" alt="Arel-AST"></p><p>From the AST, we know
* The concept of select_statement and select_core comes from
<code>SQL Design Pattern</code>
* The left, right branch concept comes from
<code>Abstract Syntax Tree</code></p><h3 id="arel-source-code-inspection"><a class="anchorlink" href="#arel-source-code-inspection">4 Arel Source Code Inspection</a></h3><div class="info"><p>Everything goes to the method: <code>to_sql</code></p></div><p>An tiny example of sql transferring</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
id    = Arel::Nodes::SqlLiteral.new('id')
count = id.count
count.to_sql

</pre>
</div>
<p>We could use pry's <code>show-method count.to_sql</code> to find the method</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
# From: lib/arel/nodes/node.rb @ line 34:
# Owner: Arel::Nodes::Node
# Visibility: public
# Number of lines: 3

def to_sql engine = Table.engine
  engine.connection.visitor.accept self
end

</pre>
</div>
<p>To find the method <code>accept</code>, we should know the ancestor chain of
<code>Arel::Table.engine.connection.visitor</code></p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
visitor = Arel::Table.engine.connection.visitor
visitor.class.ancestors
#=&gt;
#
# [
#     [ 0] ActiveRecord::ConnectionAdapters::AbstractMysqlAdapter::BindSubstitution &lt; Arel::Visitors::MySQL,
#     [ 1] Arel::Visitors::BindVisitor,
#     [ 2] Arel::Visitors::MySQL &lt; Arel::Visitors::ToSql,
#     [ 3] Arel::Visitors::ToSql &lt; Arel::Visitors::Visitor,
#     [ 4] Arel::Visitors::Visitor &lt; Object,
#     [ 5] Object &lt; BasicObject,
#     [ 6] JSON::Ext::Generator::GeneratorMethods::Object,
#     [ 7] ActiveSupport::Dependencies::Loadable,
#     [ 8] PP::ObjectMixin,
#     [ 9] Kernel,
#     [10] BasicObject
# ]

</pre>
</div>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
# Arel::Visitors::Visitor
def accept object
  visit object
end

</pre>
</div>
<p>The object here is <code>id.count</code>. Inspect the class of <code>id.count</code>
<code>ruby
id.count.class #=&gt; Arel::Nodes::Count
</code></p><p>Then we seek the <code>visit</code> method, which is the core of the Arel gem.</p><div class="info"><p>The <strong>accept, visit</strong> concepts come from the
<a href="http://en.wikipedia.org/wiki/Visitor_pattern">Visitor Pattern</a>,
while it's not the same with the traditional <code>Visitor Pattern</code>. Check this
<a href="http://web.info.uvt.ro/~oaritoni/inginerie/Cursuri/DesignPatterns/L7/Visitor/nordberg.ps.pdf">reference</a>
if you are intersted.</p></div><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
def visit object
  send dispatch[object.class], object
rescue NoMethodError =&gt; e
  raise e if respond_to?(dispatch[object.class], true)
  superklass = object.class.ancestors.find { |klass|
    respond_to?(dispatch[klass], true)
  }
  raise(TypeError, "Cannot visit #{object.class}") unless superklass
  dispatch[object.class] = dispatch[superklass]
  retry
end

</pre>
</div>
<p>Very intersting, just <code>send dispatch[object.class]</code>, that is</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
send dispatch[Arel::Nodes::Count], object
#=&gt; visit_Arel_Nodes_Count(id.count)

</pre>
</div>
<p>Finally, find the <code>visit_Arel_Nodes_Count</code> method</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
# Arel::Visitors::ToSql
def visit_Arel_Nodes_Count o
  "COUNT(#{o.distinct ? 'DISTINCT ' : ''}#{o.expressions.map { |x|
  visit x
  }.join(', ')})#{o.alias ? " AS #{visit o.alias}" : ''}"
end

</pre>
</div>
<p>Go through more complexed sql</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
user = Arel::Table.new('users')

arel = user.
  project('id', 'user_name').
  where(user[:nick_name].eq('dsg')).
  order('created_at DESC').
  skip(10).
  take(5);

arel.to_sql

</pre>
</div>
<h3 id="is-there-a-simple-way-to-create-sql-strings-questionmark"><a class="anchorlink" href="#is-there-a-simple-way-to-create-sql-strings-questionmark">5 Is there a simple way to create SQL strings?</a></h3><p>The AST, SQL Lang Pattern, Visitor Pattern may be a little complexed?
Maybe there is a simple way to create SQL strings as below:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
class NewArel
  attr_accessor :where, :select, :order, :skip, :limit

  def where(string)
    @wheres ||= []
    @wheres &lt;&lt; string

    self
  end

  def select(*args)
    @selects ||= []
    @selects = @selects.concat(args).compact.uniq

    self
  end

  def order(string)
    @orders ||= []
    @orders &lt;&lt; string

    self
  end

  # ... omited

  def to_sql
    [
      "SELECT #{@selects.join(', ')}",
      "WHERE #{@where.join('AND ')}"
    ].join(' ')
  end
end

arel = NewArel.new.
  where('id &lt; 10').
  where('id &gt; 5').
  select(:id, :user_name)

arel.to_sql

</pre>
</div>
<h3 id="what-s-more-about-arel"><a class="anchorlink" href="#what-s-more-about-arel">6 What's more about Arel</a></h3>
<ul>
<li>TreeManage

<ul>
<li>SelectManager</li>
<li>UpdateManager</li>
<li>InsertManager</li>
<li>DeleteManager</li>
</ul>
</li>
<li>visitors

<ul>
<li>mysql</li>
<li>sqlite</li>
<li>mssql</li>
<li>....</li>
</ul>
</li>
</ul>
<h3 id="reference"><a class="anchorlink" href="#reference">7 Reference</a></h3>
<ul>
<li><a href="http://pan.baidu.com/s/1hqDvjfu">kenshin54-source-code-analysis-arel</a></li>
<li><a href="http://web.info.uvt.ro/~oaritoni/inginerie/Cursuri/DesignPatterns/L7/Visitor/nordberg.ps.pdf">visitor-pattern-in-arel</a></li>
<li><a href="http://blog.bigbinary.com/2013/07/07/visitor-pattern-and-double-dispatch.html">visitor-pattern-and-double-dispatch</a></li>
<li><a href="http://jpospisil.com/2014/06/16/the-definitive-guide-to-arel-the-sql-manager-for-ruby.html">arel-guide</a></li>
</ul>


        <div id="comment"></div>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>版权声明：自由转载-非商用-非衍生-保持署名(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>)</p>
<p>
  <a href="https://github.com/996icu/996.ICU/blob/master/LICENSE"><img src="https://img.shields.io/badge/license-Anti%20996-blue.svg" /></a>
</p>

    </div>
  </div>

  <script type="text/javascript" src="javascripts/jquery.min.js"></script>
  <script type="text/javascript" src="javascripts/responsive-tables.js"></script>
  <script type="text/javascript" src="javascripts/guides.js"></script>
  <script type="text/javascript" src="javascripts/acoustic_grand_piano-ogg.js"></script>

  <!-- ./node_modules/gulp/bin/gulp.js build -\-brushes=bash,cpp,css,javascript,java,plain,python,ruby,scala,sql,xml -->
  <!-- uglifyjs syntaxhighlighter.js  -\-output syntaxhighlighter.min.js -->
  <script type="text/javascript" src="javascripts/syntaxhighlighter.min.js"></script>
  <script type="text/javascript" src="javascripts/tonal.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script> -->
  <script type="text/javascript" src="javascripts/Tone.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.4/svg.min.js"></script> -->
  <script type="text/javascript" src="javascripts/svg.min.js"></script>
  <script type="text/javascript" src="javascripts/chordy-svg.min.js"></script>
  <script type="text/javascript" src="javascripts/chord.js"></script>
  <!-- <script type="text/javascript" src="javascripts/gitalk.min.js"></script> -->
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.2.2/gitalk.min.js"></script> -->
  <script type="text/javascript" src="javascripts/gitalk.min.js"></script>
  <script type="text/javascript" src="javascripts/load_docs.js"></script>
  <script type="text/javascript" src="javascripts/Treant.js"></script>
  <!-- <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.0/raphael&#45;min.js"></script> -->
  <script type="text/javascript" src="javascripts/raphael.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.11.0/flowchart.min.js"></script> -->
  <script type="text/javascript" src="javascripts/flowchart.min.js"></script>
  <script type="text/javascript" src="javascripts/flowchart_generator.js"></script>
  <script type="text/javascript" src="javascripts/tree_generator.js"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-115746206-1"></script>

  <script type="text/javascript" src="javascripts/abcjs_midi_5.1.2-min.js"></script>
  <script type="text/javascript" src="javascripts/music_generator.js"></script>

  <script type="text/javascript">
    syntaxhighlighterConfig = {
      autoLinks: false,
    };

    $(guidesIndex.bind);

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-115746206-1');
  </script>

  <script type="text/javascript">
    var locationId = (location.pathname).split("/").pop().substring(0, 49);

    if (locationId) {
      var language = window.location.search.match("lang=en") ? "en" : "zh-CN"

      if (window.location.href.match("github")) {
        var gitalk = new Gitalk({
          clientID: '85c5f833b04d6d470db9',
          clientSecret: 'b41619fc891132558550103056197eb30baebab5',
          repo: 'blog-github-page-comments',
          owner: 'dengqinghua',
          admin: ['dengqinghua'],
          id: locationId,
          distractionFreeMode: true,
          language: language
        });
      } else {
        var gitalk = new Gitalk({
          clientID: '0f5824fe1c09851e9781',
          clientSecret: '61710a77ee98cddce06f408a398f05c8622e9575',
          repo: 'blog_comments',
          owner: 'dengqinghua',
          admin: ['dengqinghua'],
          id: locationId,
          distractionFreeMode: true,
          language: language
        });
      }

      gitalk.render('comment');
    }
  </script>
</body>
</html>
