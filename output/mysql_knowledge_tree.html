<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="baidu-site-verification" content="N1Q3HiESgp" />

<title>MySQL知识树 — dengqinghua&#39;s blog</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
  <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shCore.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shThemeRailsGuides.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/fixes.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/abcjs-midi.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/gitalk.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/Treant.css" />
  <link href="images/favicon.jpeg" rel="shortcut icon" type="image/x-icon" />
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="guide">
  <div id="topNav">
    <div class="wrapper">

      <strong class="more-info-label">More:</strong>

      <span class="red-button more-info-button">More Dengqinghua</span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://dengqinghua.github.io/about_me.html">About me</a></li>
        <li class="more-info"><a href="https://github.com/dengqinghua/">Github</a></li>
        <li class="more-info"><a href="mailto:dengqinghua.42@gmail.com">Gmail</a></li>
        <li class="more-info"><a href="https://twitter.com/dengqinghua_42">Twitter</a></li>
      </ul>

      <form action="https://google.com/search" method="get">
          <input name="q" value="site:dengqinghua.github.io" type="hidden">
          <input class="search" name="q" placeholder="Search Blog" type="text">
      </form>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="http://dengqinghua.github.io" title="Return to home page">http://dengqinghua.github.io</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="http://dengqinghua.github.io">Home</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">
            Index <span id="guidesArrow">▸</span>
          </a>

          <div id="guides" class="clearfix" style="display: none;">
            <hr />
              <dl class="L">
                <dt>推荐</dt>
                <dd><a href="badge_system.html">基于内存数据库的角标系统设计</a></dd>
                <dd><a href="witness_flow.html">业务流引擎系统</a></dd>
                <dt>Ruby</dt>
                <dd><a href="ruby_knowledge_tree.html">Ruby知识树</a></dd>
                <dd><a href="ruby_model.html">Ruby数据模型</a></dd>
                <dd><a href="arel.html?lang=en">Arel源码分析</a></dd>
                <dd><a href="sidekiq_task_event.html">基于Sidekiq的异步任务管理引擎</a></dd>
                <dd><a href="racc.html">Racc</a></dd>
                <dd><a href="witness_flow.html">业务流引擎系统</a></dd>
                <dt>Java</dt>
                <dd><a href="data_structures.html">数据结构</a></dd>
                <dd><a href="learn_jvm.html">JVM剖析</a></dd>
                <dd><a href="concurrency.html">Concurrency</a></dd>
                <dd><a href="badge_system.html">基于内存数据库的角标系统设计</a></dd>
                <dd><a href="maven_under_command_line.html">命令行下的Maven</a></dd>
                <dt>MySQL</dt>
                <dd><a href="mysql_knowledge_tree.html">MySQL知识树</a></dd>
              </dl>
              <dl class="R">
                <dt>Go</dt>
                <dd><a href="go_get_timeout_solution.html">GoInstallBinaries i/o timeout问题</a></dd>
                <dd><a href="go_knowledge_tree.html">Go知识树</a></dd>
                <dt>音乐</dt>
                <dd><a href="music_index.html">音乐学习体系</a></dd>
                <dd><a href="lalaland-city_of_stars.html">City Of Star</a></dd>
                <dd><a href="あの日の帰り道.html">あの日の帰り道</a></dd>
                <dd><a href="rain_wwh.html">雨の日はワルツを踊って</a></dd>
                <dd><a href="moon_river.html">Moon River</a></dd>
                <dd><a href="it_could_have_been.html">Es Ware Schon Gewesen</a></dd>
                <dt>杂记</dt>
                <dd><a href="example_markdown.html">markdown格式实例</a></dd>
                <dd><a href="comments.html">注释规范</a></dd>
                <dd><a href="best_programming.html">零bug落地方案</a></dd>
                <dd><a href="raft.html">Raft算法</a></dd>
                <dd><a href="memorize_my_mentor.html">Memorize My Mentor</a></dd>
              </dl>
          </div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Index</option>
              <optgroup label="推荐">
                  <option value="badge_system.html">基于内存数据库的角标系统设计</option>
                  <option value="witness_flow.html">业务流引擎系统</option>
              </optgroup>
              <optgroup label="Ruby">
                  <option value="ruby_knowledge_tree.html">Ruby知识树</option>
                  <option value="ruby_model.html">Ruby数据模型</option>
                  <option value="arel.html?lang=en">Arel源码分析</option>
                  <option value="sidekiq_task_event.html">基于Sidekiq的异步任务管理引擎</option>
                  <option value="racc.html">Racc</option>
                  <option value="witness_flow.html">业务流引擎系统</option>
              </optgroup>
              <optgroup label="Java">
                  <option value="data_structures.html">数据结构</option>
                  <option value="learn_jvm.html">JVM剖析</option>
                  <option value="concurrency.html">Concurrency</option>
                  <option value="badge_system.html">基于内存数据库的角标系统设计</option>
                  <option value="maven_under_command_line.html">命令行下的Maven</option>
              </optgroup>
              <optgroup label="MySQL">
                  <option value="mysql_knowledge_tree.html">MySQL知识树</option>
              </optgroup>
              <optgroup label="Go">
                  <option value="go_get_timeout_solution.html">GoInstallBinaries i/o timeout问题</option>
                  <option value="go_knowledge_tree.html">Go知识树</option>
              </optgroup>
              <optgroup label="音乐">
                  <option value="music_index.html">音乐学习体系</option>
                  <option value="lalaland-city_of_stars.html">City Of Star</option>
                  <option value="あの日の帰り道.html">あの日の帰り道</option>
                  <option value="rain_wwh.html">雨の日はワルツを踊って</option>
                  <option value="moon_river.html">Moon River</option>
                  <option value="it_could_have_been.html">Es Ware Schon Gewesen</option>
              </optgroup>
              <optgroup label="杂记">
                  <option value="example_markdown.html">markdown格式实例</option>
                  <option value="comments.html">注释规范</option>
                  <option value="best_programming.html">零bug落地方案</option>
                  <option value="raft.html">Raft算法</option>
                  <option value="memorize_my_mentor.html">Memorize My Mentor</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>MySQL知识树</h2><div class="date"><p>2017-08-20</p></div><p>该文档涵盖了成为MySQL专家所需要学习的知识.</p><p>阅读完该文档后，您将会了解到:</p>
<ul>
<li>MySQL基本命令.</li>
<li>MySQL索引, 锁.</li>
<li>如何分析慢查询.</li>
<li>MySQL规范</li>
<li>参考书籍</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li>
<a href="#mysql%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4">MySQL基本命令</a>

<ul>
<li><a href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%B1%87%E6%80%BB">常用命令汇总</a></li>
<li><a href="#%E5%85%B6%E4%BB%96">其他</a></li>
</ul>
</li>
<li>
<a href="#mysql%E7%B4%A2%E5%BC%95-%E9%94%81">MySQL索引, 锁</a>

<ul>
<li><a href="#%E7%B4%A2%E5%BC%95">索引</a></li>
<li><a href="#%E9%94%81">锁</a></li>
</ul>
</li>
<li>
<a href="#%E5%88%86%E6%9E%90%E6%85%A2%E6%9F%A5%E8%AF%A2">分析慢查询</a>

<ul>
<li><a href="#sql%E8%AF%AD%E5%8F%A5%E4%BC%98%E5%8C%96">sql语句优化</a></li>
<li><a href="#%E6%97%A0%E6%B3%95%E8%8E%B7%E5%8F%96%E5%86%99%E9%94%81">无法获取写锁</a></li>
<li><a href="#%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8B%E7%9A%84%E8%84%8F%E8%AF%BB%E5%92%8C%E8%84%8F%E5%86%99">高并发下的脏读和脏写</a></li>
</ul>
</li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="mysql基本命令"><a class="anchorlink" href="#mysql%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4">1 MySQL基本命令</a></h3><p>点击<a href="http://www.w3school.com.cn/sql/sql_quickref.asp">这里</a>, 查看示例</p><h4 id="常用命令汇总"><a class="anchorlink" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%B1%87%E6%80%BB">1.1 常用命令汇总</a></h4><h5 id="ddl-data-definition-language">
<a class="anchorlink" href="#ddl-data-definition-language">1.1.1 </a><a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-create-index-overview.html#innodb-online-ddl-summary-grid">DDL(Data Definition Language)</a>
</h5>
<ul>
<li>CREATE DB/TABLE</li>
<li>ADD</li>
<li>ALTER</li>
<li>DROP</li>
<li>TRUNCATE</li>
</ul>
<h5 id="dml-data-manipulation-language">
<a class="anchorlink" href="#dml-data-manipulation-language">1.1.2 </a><a href="https://dev.mysql.com/doc/refman/5.7/en/sql-syntax-data-manipulation.html">DML(Data Manipulation Language)</a>
</h5>
<ul>
<li>SELECT

<ul>
<li>WHERE</li>
<li>AND/OR/UNION</li>
<li>ORDER BY</li>
<li>JOIN(INNER, LEFT, RIGHT, FULL)</li>
<li>DISTINCT</li>
<li>DATE</li>
<li>GROUP</li>
<li>HAVING</li>
<li>IN/BETWEEN/LIKE</li>
<li>COUNT</li>
<li>SUM</li>
<li>MIN/MAX</li>
</ul>
</li>
<li>INSERT</li>
<li>UPDATE</li>
<li>DELETE</li>
</ul>
<h4 id="其他"><a class="anchorlink" href="#%E5%85%B6%E4%BB%96">1.2 其他</a></h4>
<ul>
<li>IS NULL</li>
</ul>
<h3 id="mysql索引-锁"><a class="anchorlink" href="#mysql%E7%B4%A2%E5%BC%95-%E9%94%81">2 MySQL索引, 锁</a></h3><h4 id="索引"><a class="anchorlink" href="#%E7%B4%A2%E5%BC%95">2.1 索引</a></h4>
<ul>
<li>创建索引 <code>CREATE INDEX</code>
</li>
<li>唯一性索引 <code>CREATE UNIQ INDEX</code>
</li>
<li>删除索引 <code>DELETE INDEX</code>
</li>
<li>查看索引 <code>SHOW INDEX</code>
</li>
</ul>
<h4 id="锁"><a class="anchorlink" href="#%E9%94%81">2.2 锁</a></h4>
<ul>
<li>读/写锁</li>
<li>事务, ACID</li>
<li>MVCC</li>
<li>隔离级别</li>
<li>乐观/悲观锁</li>
<li>死锁</li>
<li>获取写锁, 释放写锁</li>
</ul>
<h3 id="分析慢查询"><a class="anchorlink" href="#%E5%88%86%E6%9E%90%E6%85%A2%E6%9F%A5%E8%AF%A2">3 分析慢查询</a></h3><p>广义的慢查询问题主要包括下面三个方面</p>
<ul>
<li>单条sql语句查询时间超过100s</li>
<li>无法获取写锁</li>
<li>高并发下的脏读和脏写</li>
</ul>
<p>下面主要介绍上述三种情况下可以考虑的解决方案</p><h4 id="sql语句优化"><a class="anchorlink" href="#sql%E8%AF%AD%E5%8F%A5%E4%BC%98%E5%8C%96">3.1 sql语句优化</a></h4><p>可考虑的优化思路为:</p>
<ol>
<li>将该sql移至从库</li>
<li>使用 <a href="http://dev.mysql.com/doc/refman/5.7/en/explain.html#idm140230885036768">EXPLAIN</a>
通过explain可以看到<a href="http://www.cnitblog.com/aliyiyi08/archive/2008/09/09/48878.html">执行计划</a>
</li>
</ol>
<div class="code_container">
<pre class="brush: sql; gutter: false; toolbar: true;">
EXPLAIN for: SELECT `deals`.* FROM `deals`  WHERE ( deals.bg_tag_id &gt; 0 ) AND `deals`.`id` = 1
+----+-------------+-------+-------+-----------------------------------------------+---------+---------+-------+------+-------+
| id | select_type | table | type  | possible_keys                                 | key     | key_len | ref   | rows | Extra |
+----+-------------+-------+-------+-----------------------------------------------+---------+---------+-------+------+-------+
|  1 | SIMPLE      | deals | const | PRIMARY,idx_bg_tag_pub_beg,idx_bg_tag_pub_end | PRIMARY | 4       | const |    1 |       |
+----+-------------+-------+-------+-----------------------------------------------+---------+---------+-------+------+-------+
1 row in set (0.02 sec)

</pre>
</div>
<p>其中最重要的几列有:</p>
<ul>
<li>通过<code>key</code>列 查看 是否命中索引
key列显示MySQL实际决定使用的键（索引）。如果没有选择索引，键是NULL。要想强制MySQL使用或忽视possible_keys列中的索引，在查询中使用FORCE INDEX、USE INDEX或者IGNORE INDEX。</li>
<li>通过<code>rows</code>列 显示MySQL认为它执行查询时必须检查的行数。</li>
<li>通过<code>extra</code>列, 查看 MySQL解决查询的详细信息, 如果出现 <code>Using filesort</code> 或 <code>Using temporary</code>, 则需要优化查询</li>
</ul>

<ol>
<li>根据第二步的执行计划, 可考虑添加相关索引.</li>
<li>如果数据量过大, 添加索引无法解决问题, 则可以考虑分表.</li>
<li>出现<code>like查询</code>或者<code>全文索引</code>等查询, 需要考虑用其他的方式来解决该慢查询, 如 Solr, EsSearch等</li>
</ol>
<h4 id="无法获取写锁"><a class="anchorlink" href="#%E6%97%A0%E6%B3%95%E8%8E%B7%E5%8F%96%E5%86%99%E9%94%81">3.2 无法获取写锁</a></h4><p>无法获取到写锁一般有两种情况:</p>
<ol>
<li>在事务中执行了更新操作, 获取到了写锁, 但是在事务中迟迟没有进行commit, 如</li>
</ol>
<p>在 A 进程中, 对1024的deal进行了更新操作, 但是由于某个原因</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
ActiveRecord::Base.transction do
  deal = Deal.find(1024)
  deal.pirce = 10.24
  deal.save

  ## 因为某种原因, 该进程被hang住了
  sleep(1000)
end

</pre>
</div>
<p>此时在 B 进程中, 对1024的deal再进行更新操作, 则获取不到写锁</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
  deal = Deal.find(1024)
  deal.save # 抛异常: 等待写锁超时

</pre>
</div>

<ol>
<li><a href="http://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_deadlock">死锁</a></li>
</ol>
<h4 id="高并发下的脏读和脏写"><a class="anchorlink" href="#%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8B%E7%9A%84%E8%84%8F%E8%AF%BB%E5%92%8C%E8%84%8F%E5%86%99">3.3 高并发下的脏读和脏写</a></h4><p>该问题基本上是由于 Compare and Set 导致的，常见的场景为: 超卖</p><p>超卖的伪代码如下:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
if product.can_buy_count &gt; 0
  product.can_buy_count = product.can_buy_count - 1
  product.save
end

</pre>
</div>
<p>当高并发的情况下, 上述代码将导致 商品 product 的 可买数目 can_buy_count &lt; 0</p><p>解决上述的方法为: 添加行间锁, 并添加事务</p>

        <div id="comment"></div>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>版权声明：自由转载-非商用-非衍生-保持署名(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>)</p>
<p>
  <a href="https://github.com/996icu/996.ICU/blob/master/LICENSE"><img src="https://img.shields.io/badge/license-Anti%20996-blue.svg" /></a>
</p>

    </div>
  </div>

  <script type="text/javascript" src="javascripts/jquery.min.js"></script>
  <script type="text/javascript" src="javascripts/responsive-tables.js"></script>
  <script type="text/javascript" src="javascripts/guides.js"></script>
  <script type="text/javascript" src="javascripts/acoustic_grand_piano-ogg.js"></script>

  <!-- ./node_modules/gulp/bin/gulp.js build -\-brushes=bash,cpp,css,javascript,java,plain,python,ruby,scala,sql,xml -->
  <!-- uglifyjs syntaxhighlighter.js  -\-output syntaxhighlighter.min.js -->
  <script type="text/javascript" src="javascripts/syntaxhighlighter.min.js"></script>
  <script type="text/javascript" src="javascripts/tonal.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script> -->
  <script type="text/javascript" src="javascripts/Tone.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.4/svg.min.js"></script> -->
  <script type="text/javascript" src="javascripts/svg.min.js"></script>
  <script type="text/javascript" src="javascripts/chordy-svg.min.js"></script>
  <script type="text/javascript" src="javascripts/chord.js"></script>
  <!-- <script type="text/javascript" src="javascripts/gitalk.min.js"></script> -->
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.2.2/gitalk.min.js"></script> -->
  <script type="text/javascript" src="javascripts/gitalk.min.js"></script>
  <script type="text/javascript" src="javascripts/load_docs.js"></script>
  <script type="text/javascript" src="javascripts/Treant.js"></script>
  <!-- <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.0/raphael&#45;min.js"></script> -->
  <script type="text/javascript" src="javascripts/raphael.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.11.0/flowchart.min.js"></script> -->
  <script type="text/javascript" src="javascripts/flowchart.min.js"></script>
  <script type="text/javascript" src="javascripts/flowchart_generator.js"></script>
  <script type="text/javascript" src="javascripts/tree_generator.js"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-115746206-1"></script>

  <script type="text/javascript" src="javascripts/abcjs_midi_5.1.2-min.js"></script>
  <script type="text/javascript" src="javascripts/music_generator.js"></script>

  <script type="text/javascript">
    syntaxhighlighterConfig = {
      autoLinks: false,
    };

    $(guidesIndex.bind);

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-115746206-1');
  </script>

  <script type="text/javascript">
    var locationId = (location.pathname).split("/").pop().substring(0, 49);

    if (locationId) {
      var language = window.location.search.match("lang=en") ? "en" : "zh-CN"

      if (window.location.href.match("github")) {
        var gitalk = new Gitalk({
          clientID: '85c5f833b04d6d470db9',
          clientSecret: 'b41619fc891132558550103056197eb30baebab5',
          repo: 'blog-github-page-comments',
          owner: 'dengqinghua',
          admin: ['dengqinghua'],
          id: locationId,
          distractionFreeMode: true,
          language: language
        });
      } else {
        var gitalk = new Gitalk({
          clientID: '0f5824fe1c09851e9781',
          clientSecret: '61710a77ee98cddce06f408a398f05c8622e9575',
          repo: 'blog_comments',
          owner: 'dengqinghua',
          admin: ['dengqinghua'],
          id: locationId,
          distractionFreeMode: true,
          language: language
        });
      }

      gitalk.render('comment');
    }
  </script>
</body>
</html>
