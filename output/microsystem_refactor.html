<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="baidu-site-verification" content="N1Q3HiESgp" />

<title>Rails服务的Java Thrift微服务迁移 — dengqinghua&#39;s blog</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
  <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shCore.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shThemeRailsGuides.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/fixes.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/abcjs-midi.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/gitalk.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/Treant.css" />
  <link href="images/favicon.jpeg" rel="shortcut icon" type="image/x-icon" />
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="guide">
  <div id="topNav">
    <div class="wrapper">

      <strong class="more-info-label">More:</strong>

      <span class="red-button more-info-button">More Dengqinghua</span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://dengqinghua.github.io/about_me.html">About me</a></li>
        <li class="more-info"><a href="https://github.com/dengqinghua/">Github</a></li>
        <li class="more-info"><a href="mailto:dengqinghua.42@gmail.com">Gmail</a></li>
        <li class="more-info"><a href="https://twitter.com/dengqinghua_42">Twitter</a></li>
      </ul>

      <form action="https://google.com/search" method="get">
          <input name="q" value="site:dengqinghua.github.io" type="hidden">
          <input class="search" name="q" placeholder="Search Blog" type="text">
      </form>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="http://dengqinghua.github.io" title="Return to home page">http://dengqinghua.github.io</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="http://dengqinghua.github.io">Home</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">
            Index <span id="guidesArrow">▸</span>
          </a>

          <div id="guides" class="clearfix" style="display: none;">
            <hr />
              <dl class="L">
                <dt>推荐</dt>
                <dd><a href="badge_system.html">基于内存数据库的角标系统设计</a></dd>
                <dd><a href="witness_flow.html">业务流引擎系统</a></dd>
                <dt>Ruby</dt>
                <dd><a href="ruby_knowledge_tree.html">Ruby知识树</a></dd>
                <dd><a href="ruby_model.html">Ruby数据模型</a></dd>
                <dd><a href="arel.html?lang=en">Arel源码分析</a></dd>
                <dd><a href="sidekiq_task_event.html">基于Sidekiq的异步任务管理引擎</a></dd>
                <dd><a href="racc.html">Racc</a></dd>
                <dd><a href="witness_flow.html">业务流引擎系统</a></dd>
                <dt>Java</dt>
                <dd><a href="data_structures.html">数据结构</a></dd>
                <dd><a href="learn_jvm.html">JVM剖析</a></dd>
                <dd><a href="concurrency.html">Concurrency</a></dd>
                <dd><a href="badge_system.html">基于内存数据库的角标系统设计</a></dd>
                <dd><a href="maven_under_command_line.html">命令行下的Maven</a></dd>
                <dt>MySQL</dt>
                <dd><a href="mysql_knowledge_tree.html">MySQL知识树</a></dd>
              </dl>
              <dl class="R">
                <dt>Go</dt>
                <dd><a href="go_get_timeout_solution.html">GoInstallBinaries i/o timeout问题</a></dd>
                <dd><a href="go_knowledge_tree.html">Go知识树</a></dd>
                <dt>音乐</dt>
                <dd><a href="music_index.html">音乐学习体系</a></dd>
                <dd><a href="lalaland-city_of_stars.html">City Of Star</a></dd>
                <dd><a href="あの日の帰り道.html">あの日の帰り道</a></dd>
                <dd><a href="rain_wwh.html">雨の日はワルツを踊って</a></dd>
                <dd><a href="moon_river.html">Moon River</a></dd>
                <dd><a href="it_could_have_been.html">Es Ware Schon Gewesen</a></dd>
                <dt>杂记</dt>
                <dd><a href="example_markdown.html">markdown格式实例</a></dd>
                <dd><a href="comments.html">注释规范</a></dd>
                <dd><a href="best_programming.html">零bug落地方案</a></dd>
                <dd><a href="raft.html">Raft算法</a></dd>
                <dd><a href="memorize_my_mentor.html">Memorize My Mentor</a></dd>
              </dl>
          </div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Index</option>
              <optgroup label="推荐">
                  <option value="badge_system.html">基于内存数据库的角标系统设计</option>
                  <option value="witness_flow.html">业务流引擎系统</option>
              </optgroup>
              <optgroup label="Ruby">
                  <option value="ruby_knowledge_tree.html">Ruby知识树</option>
                  <option value="ruby_model.html">Ruby数据模型</option>
                  <option value="arel.html?lang=en">Arel源码分析</option>
                  <option value="sidekiq_task_event.html">基于Sidekiq的异步任务管理引擎</option>
                  <option value="racc.html">Racc</option>
                  <option value="witness_flow.html">业务流引擎系统</option>
              </optgroup>
              <optgroup label="Java">
                  <option value="data_structures.html">数据结构</option>
                  <option value="learn_jvm.html">JVM剖析</option>
                  <option value="concurrency.html">Concurrency</option>
                  <option value="badge_system.html">基于内存数据库的角标系统设计</option>
                  <option value="maven_under_command_line.html">命令行下的Maven</option>
              </optgroup>
              <optgroup label="MySQL">
                  <option value="mysql_knowledge_tree.html">MySQL知识树</option>
              </optgroup>
              <optgroup label="Go">
                  <option value="go_get_timeout_solution.html">GoInstallBinaries i/o timeout问题</option>
                  <option value="go_knowledge_tree.html">Go知识树</option>
              </optgroup>
              <optgroup label="音乐">
                  <option value="music_index.html">音乐学习体系</option>
                  <option value="lalaland-city_of_stars.html">City Of Star</option>
                  <option value="あの日の帰り道.html">あの日の帰り道</option>
                  <option value="rain_wwh.html">雨の日はワルツを踊って</option>
                  <option value="moon_river.html">Moon River</option>
                  <option value="it_could_have_been.html">Es Ware Schon Gewesen</option>
              </optgroup>
              <optgroup label="杂记">
                  <option value="example_markdown.html">markdown格式实例</option>
                  <option value="comments.html">注释规范</option>
                  <option value="best_programming.html">零bug落地方案</option>
                  <option value="raft.html">Raft算法</option>
                  <option value="memorize_my_mentor.html">Memorize My Mentor</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Rails服务的Java Thrift微服务迁移</h2><div class="date"><p>2017-07-28</p></div><p>面对日益复杂的业务系统和人员储备问题, 我们做了一个艰难的决定, 将原有的Ruby On Rails项目迁移为Java Thrift微服务, 对现有的业务系统进行了分析和重构, 并对业务微服务化之后的分布式事务一致性, 跨服务数据检索等提供了解决方案.</p><p>阅读完该文档后，您将会了解到:</p>
<ul>
<li>为什么要拆分为微服务</li>
<li>服务拆分颗粒度分析</li>
<li>如何解决服务间的事物一致性问题</li>
<li>如何解决跨服的数据查询问题</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li>
<a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%81%9A%E5%9F%BA%E4%BA%8Ejava%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8C%96">为什么要做基于Java的微服务化</a>

<ul>
<li><a href="#ruby%E7%94%9F%E6%80%81%E5%9C%88%E9%97%AE%E9%A2%98">Ruby生态圈问题</a></li>
<li><a href="#%E8%B7%A8%E6%9C%8D%E5%8A%A1%E7%9A%84%E8%B0%83%E7%94%A8%E5%BE%88%E9%9A%BE%E4%BF%9D%E8%AF%81%E4%B8%80%E8%87%B4%E6%80%A7">跨服务的调用很难保证一致性</a></li>
<li><a href="#%E4%BA%BA%E5%91%98%E5%9F%B9%E5%85%BB%E9%97%AE%E9%A2%98">人员培养问题</a></li>
<li><a href="#java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BC%98%E7%82%B9">Java微服务优点</a></li>
</ul>
</li>
<li>
<a href="#%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E5%8E%9F%E5%88%99">服务拆分原则</a>

<ul>
<li><a href="#%E5%87%8F%E5%B0%91%E6%9C%8D%E5%8A%A1%E4%B9%8B%E9%97%B4%E5%8F%8C%E5%90%91%E8%B0%83%E7%94%A8">减少服务之间双向调用</a></li>
<li><a href="#%E5%AF%B9%E4%BA%8E%E7%BB%9F%E8%AE%A1%E7%B1%BB%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9C%8D%E5%8A%A1%E6%8A%BD%E7%A6%BB%E6%88%90%E5%8D%95%E7%8B%AC%E7%9A%84%E6%9C%8D%E5%8A%A1">对于统计类的数据服务抽离成单独的服务</a></li>
<li><a href="#%E5%BB%BA%E7%AB%8B%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1">建立基础服务</a></li>
</ul>
</li>
<li>
<a href="#%E8%B7%A8%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%BA%8B%E5%8A%A1%E4%B8%80%E8%87%B4%E6%80%A7">跨服务的事务一致性</a>

<ul>
<li><a href="#%E4%BA%8B%E5%8A%A1%E4%B8%80%E8%87%B4%E6%80%A7%E8%A1%A8">事务一致性表</a></li>
<li><a href="#%E4%BC%98%E7%BC%BA%E7%82%B9%E5%88%86%E6%9E%90">优缺点分析</a></li>
</ul>
</li>
<li>
<a href="#%E8%B7%A8%E6%9C%8D%E5%8A%A1%E6%9F%A5%E8%AF%A2">跨服务查询</a>

<ul>
<li><a href="#%E4%BE%8B%E5%AD%90">例子</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%BF%83">数据中心</a></li>
</ul>
</li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="为什么要做基于java的微服务化"><a class="anchorlink" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%81%9A%E5%9F%BA%E4%BA%8Ejava%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8C%96">1 为什么要做基于Java的微服务化</a></h3>
<blockquote>
<p>Rails is an APPLICATION, not a SYSTEM  ---- 亚历山大 K Liu</p>
</blockquote>
<h4 id="ruby生态圈问题"><a class="anchorlink" href="#ruby%E7%94%9F%E6%80%81%E5%9C%88%E9%97%AE%E9%A2%98">1.1 Ruby生态圈问题</a></h4><p>公司的其他核心服务是Java语言写的, 基于Dubbo的RPC Thrift框架, 服务之间的消息队列为kafak, 数据的汇总和收集使用的是Hive和ES.</p><p>对于Ruby而言, 上述技术相关的插件支持度不是很好, 对应的客户端也有很多问题, 为了解决上述问题, 我们不得不花大量时间去看源码, 并给插件打补丁, 降低了团队的整体的开发效率</p><h4 id="跨服务的调用很难保证一致性"><a class="anchorlink" href="#%E8%B7%A8%E6%9C%8D%E5%8A%A1%E7%9A%84%E8%B0%83%E7%94%A8%E5%BE%88%E9%9A%BE%E4%BF%9D%E8%AF%81%E4%B8%80%E8%87%B4%E6%80%A7">1.2 跨服务的调用很难保证一致性</a></h4><p>Rails虽然提供了很多AOP操作, 其中一些和事务相关, 如<a href="http://guides.rubyonrails.org/active_record_callbacks.html#transaction-callbacks">after_save, after_commit, after_rollback</a>, 但是我们的系统中, 一些核心业务是用Java写的, 服务之间通过RPC Thrift进行调用. 一个跨服务的例子为:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
class Activity
  ##
  # ==== Description
  #  创建商品
  #
  #  1. 创建活动基本信息
  #  2. 如果设置了优惠, 将调用优惠系统的接口, 将商品相关信息录入到优惠系统中 (优惠系统是另外一个java语言的系统)
  #  3. 保存优惠id至活动关联表中
  #
  def self.generate_activity(params)
    activity = create_activity(params) # 新创建一个活动

    if activity.has_set_discount?
      data = generate_discount_info(activity.id) # 调用外部接口, 创建优惠
      save_discount_id # 保存优惠id至关联表关系
    end
  end
end

</pre>
</div>
<p>上述是一个简单的例子, 如果一切都正常, 则商品表中正常存储了优惠的id, 优惠信息也成功录入至优惠系统中.</p><p>优惠系统慢慢演进之后, 我们发现了很多活动创建优惠失败了, 排查之后, 发现优惠添加了新的校验, 由于业务逻辑上使得优惠无法添加成功, 于是代码优化为:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
class Activity
  ##
  # ==== Description
  #  创建商品
  #
  #  0. 创建事务
  #  1. 创建活动基本信息
  #  2. 如果设置了优惠, 将调用优惠系统的接口, 将商品相关信息录入到优惠系统中 (优惠系统是另外一个java语言的系统)
  #  3. 保存优惠id至商品关联表中
  #
  def self.generate_activity(params)
    # 创建一个事务, 如果接口返回失败, 则整体回滚
    Activity.transaction do
      activity = create_activity(params) # 新创建一个活动

      if activity.has_set_discount?
        data = generate_discount_info(activity.product_id) # 调用外部接口, 创建优惠
        save_discount_id # 保存优惠id至关联表关系
      end
    end
  end
end

</pre>
</div>
<p>此时我们又发现一些bug: 优惠系统里面有该活动对应的商品id, 但是活动没有创建成功! 是因为</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
save_discount_id

</pre>
</div>
<p>在保存discount_id的时候报错了, 导致了整个事务回滚, 但是接口部分的数据没有办法回滚, 依旧有数据不一致的情况</p><h4 id="人员培养问题"><a class="anchorlink" href="#%E4%BA%BA%E5%91%98%E5%9F%B9%E5%85%BB%E9%97%AE%E9%A2%98">1.3 人员培养问题</a></h4><p>随着Python, Go, NodeJS的流行, 业界中Ruby的使用者越来越少, 很多Rubyist都慢慢地转向了其他的语言. 从而使得招聘困难, 团队整体的压力变大, 不利于需求的快速响应和处理, 大量需求超期, 造成恶性循环.</p><h4 id="java微服务优点"><a class="anchorlink" href="#java%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BC%98%E7%82%B9">1.4 Java微服务优点</a></h4>
<ul>
<li>服务调用情况可以很好的被监控</li>
<li>服务可进行降级和伸缩</li>
<li>Java生态圈完善</li>
</ul>
<h3 id="服务拆分原则"><a class="anchorlink" href="#%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E5%8E%9F%E5%88%99">2 服务拆分原则</a></h3><h4 id="减少服务之间双向调用"><a class="anchorlink" href="#%E5%87%8F%E5%B0%91%E6%9C%8D%E5%8A%A1%E4%B9%8B%E9%97%B4%E5%8F%8C%E5%90%91%E8%B0%83%E7%94%A8">2.1 减少服务之间双向调用</a></h4><p>如果服务之间耦合紧密, 在一个方法中需要循环调用, 如</p><div class="code_container">
<pre class="brush: java; gutter: false; toolbar: true;">
  Service A#method1 -&gt; Service B#method1 -&gt; Service A#method2

</pre>
</div>
<p>服务A 调用 B 之后, B 再调用 服务 A, 这样如果其中一个出错, 整体进行回滚, 此时无法保证两个服务中三个表的整体的事务一致性.</p><p>所以对于上述这种情况, 我们选择将<code>A</code>和<code>B</code>合并为一个服务</p><h4 id="对于统计类的数据服务抽离成单独的服务"><a class="anchorlink" href="#%E5%AF%B9%E4%BA%8E%E7%BB%9F%E8%AE%A1%E7%B1%BB%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9C%8D%E5%8A%A1%E6%8A%BD%E7%A6%BB%E6%88%90%E5%8D%95%E7%8B%AC%E7%9A%84%E6%9C%8D%E5%8A%A1">2.2 对于统计类的数据服务抽离成单独的服务</a></h4><p>一到月末, 年末的时候, 便会出现很多数据汇总, 邮件等需求, 该业务需求存活周期短, 响应要求高. 我们将这类的统计需求放在一个独立的服务中, 如</p>
<ul>
<li>对账服务</li>
<li>绩效考核统计</li>
<li>卖家评分数据计算</li>
<li>管理员工作台数据</li>
</ul>
<h4 id="建立基础服务"><a class="anchorlink" href="#%E5%BB%BA%E7%AB%8B%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1">2.3 建立基础服务</a></h4><p>在项目中, 对于一些常用的组件, 我们将他抽离成一个单独的基础服务, 如</p>
<ul>
<li>服务监控</li>
<li>日志收集</li>
<li>一致性事务监控</li>
<li>工作流引擎</li>
</ul>
<h3 id="跨服务的事务一致性"><a class="anchorlink" href="#%E8%B7%A8%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%BA%8B%E5%8A%A1%E4%B8%80%E8%87%B4%E6%80%A7">3 跨服务的事务一致性</a></h3><h4 id="事务一致性表"><a class="anchorlink" href="#%E4%BA%8B%E5%8A%A1%E4%B8%80%E8%87%B4%E6%80%A7%E8%A1%A8">3.1 事务一致性表</a></h4><div class="code_container">
<pre class="brush: sql; gutter: false; toolbar: true;">
sync_transactions | CREATE TABLE `sync_transactions` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `target_id` int(11) NOT NULL DEFAULT '0' COMMENT '业务系统的主键id',
  `target_type` int(11) NOT NULL DEFAULT '0' COMMENT '业务系统名称字典',
  `status` tinyint(4) NOT NULL DEFAULT '0' COMMENT '处理状态：0-未处理 1-已处理',
  `created_at` datetime NOT NULL,
  `updated_at` datetime NOT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_target_id_type` (`target_id`,`target_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='同步事务表'

</pre>
</div>
<p>我们使用一致性事务表来保证事务一致性, 对于强一致性的业务, 我们的处理步骤如下:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
class Activity
  def self.generate_activity(params)
    Activity.transaction do
      activity = create_activity(params) # 新创建一个活动

      if activity.has_set_discount?
        # 仅仅在事务中创建一条事务记录
        transaction = create_sync_transactions(activity.id, activity.name, stauts: "待处理")
      end
    end

    # 在事务外进行处理
    if activity.has_set_discount?
      begin
        data = generate_discount_info(activity.product_id) # 调用外部接口, 创建优惠
        save_discount_id # 保存优惠id至关联表关系
        transaction.set_status("处理完成")
      rescue
        Rails.logger.error("处理失败")
        push_to_transction_queue(transaction.id)
      end
    end
  end
end

</pre>
</div>
<p>我们创建了一条事务队列, 对于失败的事务, 会推入队列中处理, 如果在队列中失败多次, 则进行业务报警.</p><h4 id="优缺点分析"><a class="anchorlink" href="#%E4%BC%98%E7%BC%BA%E7%82%B9%E5%88%86%E6%9E%90">3.2 优缺点分析</a></h4><h5 id="优点"><a class="anchorlink" href="#%E4%BC%98%E7%82%B9">3.2.1 优点</a></h5>
<ul>
<li>将调用外部服务抽离出了MySQL的事务, 使得系统的事务变得更轻量, 性能更好</li>
<li>将事务的一致性问题转变为: 事务队列 + 重试报警. 一些逻辑上的问题可以预知, 并提前处理</li>
</ul>
<h5 id="缺点"><a class="anchorlink" href="#%E7%BC%BA%E7%82%B9">3.2.2 缺点</a></h5>
<ul>
<li>sync_transactions表中增长非常快, 需要及时进行清理</li>
<li>在队列中轮询的时候要原有业务系统的数据状态, 可能会导致脏读和幻读的问题</li>
</ul>
<h3 id="跨服务查询"><a class="anchorlink" href="#%E8%B7%A8%E6%9C%8D%E5%8A%A1%E6%9F%A5%E8%AF%A2">4 跨服务查询</a></h3><h4 id="例子"><a class="anchorlink" href="#%E4%BE%8B%E5%AD%90">4.1 例子</a></h4><p>我们在业务系统中有一个这样的需求:</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: true;">
查询 卖家等级为 A, 而且 商品的 dsr &lt; 5 的商品列表

</pre>
</div>
<p>我们拆分了微服务之后, <code>卖家的数据</code> 和 <code>商品的数据</code> 已经在不同的数据库实例了, 没有办法简单地进行关联查询.</p><p>可选择的方案为</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: true;">
1. 商品服务调用卖家服务接口, 或者卖家等级为A的所有卖家id: sellerIds = requestALevelSellersService
2. 查询所有的商品中, 卖家id为步骤1返回的数据:  SELECT * FROM products WHERE seller_id IN (sellerIds) LIMIT 20

</pre>
</div>
<p>这种方式可以查出数据, 但是存在下面几个问题</p>
<ul>
<li>IN 查询中, 查询的id太多, 性能很差</li>
<li>分页排序错乱</li>
</ul>
<div class="note"><p>在数据中心出现之前, 我们经常拒绝该类需求, 而是通过异步导出的方式给业务方提供数据.</p></div><h4 id="数据中心"><a class="anchorlink" href="#%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%BF%83">4.2 数据中心</a></h4><p>我们建立了基于卖家平台的数据中心系统, 他实现了</p>
<ul>
<li>定制数据视图和相应的字段</li>
<li>监控不同数据库实例binlog的变化, 同步更新数据到一个新的数据视图中</li>
<li>提供统一的查询接口</li>
</ul>
<h5 id="优缺点"><a class="anchorlink" href="#%E4%BC%98%E7%BC%BA%E7%82%B9">4.2.1 优缺点</a></h5><p>数据中心能解决跨服务查询的问题, 但是他存在一些问题</p>
<ul>
<li>数据更新延迟</li>
<li>ES的更新策略是基于乐观锁, 一些幻读和脏读可能导致数据不正确</li>
</ul>
<p>但是总的来说, 我们将数据写入和数据查询剥离, 整体的复杂度降低了, 团队开发效率得到了极大的提升.</p>

        <div id="comment"></div>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>版权声明：自由转载-非商用-非衍生-保持署名(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>)</p>
<p>
  <a href="https://github.com/996icu/996.ICU/blob/master/LICENSE"><img src="https://img.shields.io/badge/license-Anti%20996-blue.svg" /></a>
</p>

    </div>
  </div>

  <script type="text/javascript" src="javascripts/jquery.min.js"></script>
  <script type="text/javascript" src="javascripts/responsive-tables.js"></script>
  <script type="text/javascript" src="javascripts/guides.js"></script>
  <script type="text/javascript" src="javascripts/acoustic_grand_piano-ogg.js"></script>

  <!-- ./node_modules/gulp/bin/gulp.js build -\-brushes=bash,cpp,css,javascript,java,plain,python,ruby,scala,sql,xml -->
  <!-- uglifyjs syntaxhighlighter.js  -\-output syntaxhighlighter.min.js -->
  <script type="text/javascript" src="javascripts/syntaxhighlighter.min.js"></script>
  <script type="text/javascript" src="javascripts/tonal.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script> -->
  <script type="text/javascript" src="javascripts/Tone.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.4/svg.min.js"></script> -->
  <script type="text/javascript" src="javascripts/svg.min.js"></script>
  <script type="text/javascript" src="javascripts/chordy-svg.min.js"></script>
  <script type="text/javascript" src="javascripts/chord.js"></script>
  <!-- <script type="text/javascript" src="javascripts/gitalk.min.js"></script> -->
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.2.2/gitalk.min.js"></script> -->
  <script type="text/javascript" src="javascripts/gitalk.min.js"></script>
  <script type="text/javascript" src="javascripts/load_docs.js"></script>
  <script type="text/javascript" src="javascripts/Treant.js"></script>
  <!-- <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.0/raphael&#45;min.js"></script> -->
  <script type="text/javascript" src="javascripts/raphael.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.11.0/flowchart.min.js"></script> -->
  <script type="text/javascript" src="javascripts/flowchart.min.js"></script>
  <script type="text/javascript" src="javascripts/flowchart_generator.js"></script>
  <script type="text/javascript" src="javascripts/tree_generator.js"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-115746206-1"></script>

  <script type="text/javascript" src="javascripts/abcjs_midi_5.1.2-min.js"></script>
  <script type="text/javascript" src="javascripts/music_generator.js"></script>

  <script type="text/javascript">
    syntaxhighlighterConfig = {
      autoLinks: false,
    };

    $(guidesIndex.bind);

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-115746206-1');
  </script>

  <script type="text/javascript">
    var locationId = (location.pathname).split("/").pop().substring(0, 49);

    if (locationId) {
      var language = window.location.search.match("lang=en") ? "en" : "zh-CN"

      if (window.location.href.match("github")) {
        var gitalk = new Gitalk({
          clientID: '85c5f833b04d6d470db9',
          clientSecret: 'b41619fc891132558550103056197eb30baebab5',
          repo: 'blog-github-page-comments',
          owner: 'dengqinghua',
          admin: ['dengqinghua'],
          id: locationId,
          distractionFreeMode: true,
          language: language
        });
      } else {
        var gitalk = new Gitalk({
          clientID: '0f5824fe1c09851e9781',
          clientSecret: '61710a77ee98cddce06f408a398f05c8622e9575',
          repo: 'blog_comments',
          owner: 'dengqinghua',
          admin: ['dengqinghua'],
          id: locationId,
          distractionFreeMode: true,
          language: language
        });
      }

      gitalk.render('comment');
    }
  </script>
</body>
</html>
