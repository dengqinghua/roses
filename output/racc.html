<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="baidu-site-verification" content="N1Q3HiESgp" />

<title>Racc — dengqinghua&#39;s blog</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
  <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shCore.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shThemeRailsGuides.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/fixes.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/abcjs-midi.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/gitalk.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/Treant.css" />
  <link href="images/favicon.jpeg" rel="shortcut icon" type="image/x-icon" />
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="guide">
  <div id="topNav">
    <div class="wrapper">

      <strong class="more-info-label">More:</strong>

      <span class="red-button more-info-button">More Dengqinghua</span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://dengqinghua.github.io/about_me.html">About me</a></li>
        <li class="more-info"><a href="https://github.com/dengqinghua/">Github</a></li>
        <li class="more-info"><a href="mailto:dengqinghua.42@gmail.com">Gmail</a></li>
        <li class="more-info"><a href="https://twitter.com/dengqinghua_42">Twitter</a></li>
      </ul>

      <form action="https://google.com/search" method="get">
          <input name="q" value="site:dengqinghua.github.io" type="hidden">
          <input class="search" name="q" placeholder="Search Blog" type="text">
      </form>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="http://dengqinghua.github.io" title="Return to home page">http://dengqinghua.github.io</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="http://dengqinghua.github.io">Home</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">
            Index <span id="guidesArrow">▸</span>
          </a>

          <div id="guides" class="clearfix" style="display: none;">
            <hr />
              <dl class="L">
                <dt>推荐</dt>
                <dd><a href="badge_system.html">基于内存数据库的角标系统设计</a></dd>
                <dd><a href="witness_flow.html">业务流引擎系统</a></dd>
                <dt>Ruby</dt>
                <dd><a href="ruby_knowledge_tree.html">Ruby知识树</a></dd>
                <dd><a href="ruby_model.html">Ruby数据模型</a></dd>
                <dd><a href="arel.html?lang=en">Arel源码分析</a></dd>
                <dd><a href="sidekiq_task_event.html">基于Sidekiq的异步任务管理引擎</a></dd>
                <dd><a href="racc.html">Racc</a></dd>
                <dd><a href="witness_flow.html">业务流引擎系统</a></dd>
                <dt>Java</dt>
                <dd><a href="data_structures.html">数据结构</a></dd>
                <dd><a href="learn_jvm.html">JVM剖析</a></dd>
                <dd><a href="concurrency.html">Concurrency</a></dd>
                <dd><a href="badge_system.html">基于内存数据库的角标系统设计</a></dd>
                <dd><a href="maven_under_command_line.html">命令行下的Maven</a></dd>
                <dt>MySQL</dt>
                <dd><a href="mysql_knowledge_tree.html">MySQL知识树</a></dd>
              </dl>
              <dl class="R">
                <dt>Go</dt>
                <dd><a href="go_get_timeout_solution.html">GoInstallBinaries i/o timeout问题</a></dd>
                <dd><a href="go_knowledge_tree.html">Go知识树</a></dd>
                <dt>音乐</dt>
                <dd><a href="music_index.html">音乐学习体系</a></dd>
                <dd><a href="lalaland-city_of_stars.html">City Of Star</a></dd>
                <dd><a href="あの日の帰り道.html">あの日の帰り道</a></dd>
                <dd><a href="rain_wwh.html">雨の日はワルツを踊って</a></dd>
                <dd><a href="moon_river.html">Moon River</a></dd>
                <dd><a href="it_could_have_been.html">Es Ware Schon Gewesen</a></dd>
                <dt>杂记</dt>
                <dd><a href="example_markdown.html">markdown格式实例</a></dd>
                <dd><a href="comments.html">注释规范</a></dd>
                <dd><a href="best_programming.html">零bug落地方案</a></dd>
                <dd><a href="raft.html">Raft算法</a></dd>
                <dd><a href="memorize_my_mentor.html">Memorize My Mentor</a></dd>
              </dl>
          </div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Index</option>
              <optgroup label="推荐">
                  <option value="badge_system.html">基于内存数据库的角标系统设计</option>
                  <option value="witness_flow.html">业务流引擎系统</option>
              </optgroup>
              <optgroup label="Ruby">
                  <option value="ruby_knowledge_tree.html">Ruby知识树</option>
                  <option value="ruby_model.html">Ruby数据模型</option>
                  <option value="arel.html?lang=en">Arel源码分析</option>
                  <option value="sidekiq_task_event.html">基于Sidekiq的异步任务管理引擎</option>
                  <option value="racc.html">Racc</option>
                  <option value="witness_flow.html">业务流引擎系统</option>
              </optgroup>
              <optgroup label="Java">
                  <option value="data_structures.html">数据结构</option>
                  <option value="learn_jvm.html">JVM剖析</option>
                  <option value="concurrency.html">Concurrency</option>
                  <option value="badge_system.html">基于内存数据库的角标系统设计</option>
                  <option value="maven_under_command_line.html">命令行下的Maven</option>
              </optgroup>
              <optgroup label="MySQL">
                  <option value="mysql_knowledge_tree.html">MySQL知识树</option>
              </optgroup>
              <optgroup label="Go">
                  <option value="go_get_timeout_solution.html">GoInstallBinaries i/o timeout问题</option>
                  <option value="go_knowledge_tree.html">Go知识树</option>
              </optgroup>
              <optgroup label="音乐">
                  <option value="music_index.html">音乐学习体系</option>
                  <option value="lalaland-city_of_stars.html">City Of Star</option>
                  <option value="あの日の帰り道.html">あの日の帰り道</option>
                  <option value="rain_wwh.html">雨の日はワルツを踊って</option>
                  <option value="moon_river.html">Moon River</option>
                  <option value="it_could_have_been.html">Es Ware Schon Gewesen</option>
              </optgroup>
              <optgroup label="杂记">
                  <option value="example_markdown.html">markdown格式实例</option>
                  <option value="comments.html">注释规范</option>
                  <option value="best_programming.html">零bug落地方案</option>
                  <option value="raft.html">Raft算法</option>
                  <option value="memorize_my_mentor.html">Memorize My Mentor</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Racc</h2><div class="date"><p>2018-05-11</p></div><p>这个是Racc的使用示例介绍.</p><p>阅读完该文档之后, 您将了解到:</p>
<ul>
<li>Rex和Racc的关系</li>
<li>如何使用Racc进行自定义</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#tl-dr">TL;DR</a></li>
<li>
<a href="#rex-%E5%92%8C-racc-%E7%9A%84%E6%9D%A5%E6%BA%90">Rex 和 Racc 的来源</a>

<ul>
<li><a href="#yacc%E5%92%8Clexical">Yacc和Lexical</a></li>
<li><a href="#git%E5%9C%B0%E5%9D%80">Git地址</a></li>
</ul>
</li>
<li>
<a href="#rex">Rex</a>

<ul>
<li><a href="#rex-%E7%A4%BA%E4%BE%8B">示例</a></li>
</ul>
</li>
<li>
<a href="#racc">Racc</a>

<ul>
<li><a href="#racc-%E7%A4%BA%E4%BE%8B">示例</a></li>
</ul>
</li>
<li><a href="#%E7%BC%96%E8%AF%91">编译</a></li>
<li><a href="#references">References</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="tl-dr"><a class="anchorlink" href="#tl-dr">1 TL;DR</a></h3><p>我们在做数据中心的时候, <a href="http://blog.dengqinghua.net/badge_system.html">计算引擎</a>都是基于SQL的.</p><p>在Java生态中, 我们有很多解析SQL的工具, 如 <a href="https://github.com/alibaba/druid">Druid</a>.</p><p>Ruby中我们使用 <a href="https://github.com/cryodex/sql-parser">sql-parser</a></p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
require 'sql-parser'
parser = SQLParser::Parser.new

# Build the AST from a SQL statement
ast = parser.scan_str('SELECT * FROM users WHERE id = 1')

# Find which columns where selected in the FROM clause
ast.select_list.to_sql
#=&gt; "*"

# Output the table expression as SQL
ast.table_expression.to_sql
#=&gt; "FROM users WHERE id = 1"

# Drill down into the WHERE clause, to examine every piece
ast.table_expression.where_clause.to_sql
#=&gt; "WHERE id = 1"
ast.table_expression.where_clause.search_condition.to_sql
#=&gt; "id = 1"
ast.table_expression.where_clause.search_condition.left.to_sql
#=&gt; "id"

</pre>
</div>
<p>但是发现该功能的SQL解析能力有限, 我们使用了很多<code>SQL函数</code>, <strong>该插件并不支持复杂的SQL函数</strong>.</p><p>我们希望可以对此插件进行扩展. 阅读源码后发现, 源码核心是由两个文件</p>
<ul>
<li><a href="https://github.com/cryodex/sql-parser/blob/master/lib/sql-parser/parser.racc">parser.racc</a></li>
<li><a href="https://github.com/cryodex/sql-parser/blob/master/lib/sql-parser/parser.rex">parser.rex</a></li>
</ul>
<p>阅读了一下相关资料, 得知 <code>Yacc</code> 和 <code>Rexical</code> 的概念</p><p>也就是说 SQL 解析分为两部分</p>
<ol>
<li>patterns, 用 <code>parser.rex</code> 来配置, 如 SELECT, ORDER 等词汇</li>
<li>grammar,  用 <code>parser.racc</code> 来配置, 定义了语法, 即 SELECT, ORDER 的组合方式</li>
</ol>
<p>故遇到一条SQL</p><div class="code_container">
<pre class="brush: sql; gutter: false; toolbar: true;">
SELECT * FROM orders WHERE id = 1

</pre>
</div>
<p>的时候, 会分析出 patterns</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
SELECT
*
FROM
WHERE

</pre>
</div>
<p>再根据 <code>语法</code> 进行正则匹配即可.</p><p>下面的文档是介绍了 Rex 和 Racc 的作用 和 使用方式.</p><p>示例代码可以在 <a href="https://github.com/dengqinghua/my_examples/tree/master/ruby/racc">这里</a> 查看</p><h3 id="rex-和-racc-的来源"><a class="anchorlink" href="#rex-%E5%92%8C-racc-%E7%9A%84%E6%9D%A5%E6%BA%90">2 Rex 和 Racc 的来源</a></h3><h4 id="yacc和lexical"><a class="anchorlink" href="#yacc%E5%92%8Clexical">2.1 Yacc和Lexical</a></h4><p>Racc和Rex分别来源于单词 <a href="https://en.wikipedia.org/wiki/Yacc">Yacc</a> 和 <code>Lexical Analyser</code></p><p>在我们定义一个语言的时候, 需要解决两个问题</p>
<ol>
<li>有哪些词汇(patterns)?</li>
<li>有哪些语法(grammar)?</li>
</ol>
<p>其中 Lexical 就是<code>词汇</code>的抽象, Yacc 就是<code>语法</code>的抽象</p><p>下面是一个语法解析的过程示例:</p><p><img src="https://raw.githubusercontent.com/dengqinghua/roses/master/assets/images/racc_example.png" alt="racc_example"></p><p>图片和对应的文档来源于<a href="http://epaperpress.com/lexandyacc/intro.html">这里</a></p><p>对应Racc和Rex, 也是做相同的事情, 仅仅是解析和定义的语言为Ruby, 所以用R开头</p><h4 id="git地址"><a class="anchorlink" href="#git%E5%9C%B0%E5%9D%80">2.2 Git地址</a></h4>
<ul>
<li><a href="https://github.com/tenderlove/racc">Racc</a></li>
<li><a href="https://github.com/tenderlove/rexical">Rexical</a></li>
</ul>
<h3 id="rex"><a class="anchorlink" href="#rex">3 Rex</a></h3><h4 id="rex-示例"><a class="anchorlink" href="#rex-%E7%A4%BA%E4%BE%8B">3.1 示例</a></h4><p>在示例代码 <a href="https://github.com/dengqinghua/my_examples/blob/master/ruby/racc/calculator.rex">calculator.rex</a> 定义了词汇</p><p>如规则</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
macro
  DIGIT_MACRO     \d+

rule
  {DIGIT_MACRO} { [:DIGIT, text.to_i] }

</pre>
</div>
<p>表示的是 遇到了数字, 那么解析成 [:DIGIT, 数字] 的形式, 即</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: true;">
输入 1024, 解析为词汇 [:DIGIT, 1024]

</pre>
</div>
<p>为什么要有一个 <code>:DIGIT</code> 的标识呢? 是因为我们需要将相同属性的东西进行标记, 下一步进行语法申明的时候可以用到</p><div class="note"><p>参考: <a href="http://testerstories.com/2012/06/a-tester-learns-rex-and-racc-part-1/">a-tester-learns-rex-and-racc-part-1</a></p></div><h3 id="racc"><a class="anchorlink" href="#racc">4 Racc</a></h3><h4 id="racc-示例"><a class="anchorlink" href="#racc-%E7%A4%BA%E4%BE%8B">4.1 示例</a></h4><p>有了词汇之后, 我们就可以定义语法了.</p><p>在示例代码 <a href="https://github.com/dengqinghua/my_examples/blob/master/ruby/racc/calculator.y">calculator.y</a> 定义了语法</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
rule
  expression
    :
    DIGIT
    | DIGIT ADD DIGIT { return val[0] + val[2] }
    | DIGIT SUBSTRACT DIGIT { return val[0] - val[2] }
    | DIGIT MULTIPLY DIGIT { return val[0] * val[2] }
    | DIGIT DIVIDE DIGIT { return val[0] / val[2] }
end

</pre>
</div>
<p>一些注释如下</p>
<ol>
<li>expression 仅仅是一个名词, 可以起名为abc, bcd都行, 他可以被复用, 即规则可以嵌套使用.  ":"后面是代表各种不同的情况, | 代表 或</li>
<li>DIGIT ADD SUBSTRACT 等, 均为 calculator.rex 中申明的词汇(patterns)</li>
<li>
<p>val是指匹配成功之后, 对应的值</p>
<p>如字符串 <code>2 + 2</code>, 匹配到了 <code>DIGIT ADD DIGIT</code> 这部分, 则</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
val[0] = 2
val[1] = "+"
val[2] = 2

</pre>
</div>
</li>
<li><p>{} 表示的是ruby代码, 即如何处理该语法.</p></li>
</ol>
<h3 id="编译"><a class="anchorlink" href="#%E7%BC%96%E8%AF%91">5 编译</a></h3><p>编译的过程是生成ruby代码的过程, 包括 rex 和 racc 两部分</p><p>执行</p><div class="code_container">
<pre class="brush: shell; gutter: false; toolbar: true;">
rex calculator.rex -o calculator.rex.rb
racc calculator.y -o calculator.racc.rb

</pre>
</div>
<div class="note"><p>在这之前需要安装 racc 这个gem. 可以通过 <code>gem install racc</code> 进行安装</p></div><p>此时有一个 <code>calculator.racc.rb</code> 文件. 我们可以起一个pry进行测试</p><div class="note"><p>希望之后可以添加Rspec测试, 这样更加直观和规范</p></div><div class="code_container">
<pre class="brush: shell; gutter: false; toolbar: true;">
pry -r ./calculator.racc.rb

</pre>
</div>
<p>在console中输入</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
Calculator.new.parse("2 + 2") #=&gt; 输出 4
Calculator.new.parse("2 - 2") #=&gt; 输出 0
Calculator.new.parse("2 * 3") #=&gt; 输出 6
Calculator.new.parse("2 / 1") #=&gt; 输出 2
Calculator.new.parse("2 | 1") #=&gt; 抛出异常, 因为 | 无法解析: parse error on value 2 (DIGIT)

</pre>
</div>
<p>可以看到对应的结果.</p><h3 id="references"><a class="anchorlink" href="#references">6 References</a></h3>
<ul>
<li><a href="http://epaperpress.com/lexandyacc/intro.html">Lex and Yacc</a></li>
<li><a href="http://testerstories.com/category/language-building/rex-and-racc/">Rex-and-Racc</a></li>
</ul>


        <div id="comment"></div>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>版权声明：自由转载-非商用-非衍生-保持署名(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>)</p>
<p>
  <a href="https://github.com/996icu/996.ICU/blob/master/LICENSE"><img src="https://img.shields.io/badge/license-Anti%20996-blue.svg" /></a>
</p>

    </div>
  </div>

  <script type="text/javascript" src="javascripts/jquery.min.js"></script>
  <script type="text/javascript" src="javascripts/responsive-tables.js"></script>
  <script type="text/javascript" src="javascripts/guides.js"></script>
  <script type="text/javascript" src="javascripts/acoustic_grand_piano-ogg.js"></script>

  <!-- ./node_modules/gulp/bin/gulp.js build -\-brushes=bash,cpp,css,javascript,java,plain,python,ruby,scala,sql,xml -->
  <!-- uglifyjs syntaxhighlighter.js  -\-output syntaxhighlighter.min.js -->
  <script type="text/javascript" src="javascripts/syntaxhighlighter.min.js"></script>
  <script type="text/javascript" src="javascripts/tonal.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script> -->
  <script type="text/javascript" src="javascripts/Tone.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.4/svg.min.js"></script> -->
  <script type="text/javascript" src="javascripts/svg.min.js"></script>
  <script type="text/javascript" src="javascripts/chordy-svg.min.js"></script>
  <script type="text/javascript" src="javascripts/chord.js"></script>
  <!-- <script type="text/javascript" src="javascripts/gitalk.min.js"></script> -->
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.2.2/gitalk.min.js"></script> -->
  <script type="text/javascript" src="javascripts/gitalk.min.js"></script>
  <script type="text/javascript" src="javascripts/load_docs.js"></script>
  <script type="text/javascript" src="javascripts/Treant.js"></script>
  <!-- <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.0/raphael&#45;min.js"></script> -->
  <script type="text/javascript" src="javascripts/raphael.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.11.0/flowchart.min.js"></script> -->
  <script type="text/javascript" src="javascripts/flowchart.min.js"></script>
  <script type="text/javascript" src="javascripts/flowchart_generator.js"></script>
  <script type="text/javascript" src="javascripts/tree_generator.js"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-115746206-1"></script>

  <script type="text/javascript" src="javascripts/abcjs_midi_5.1.2-min.js"></script>
  <script type="text/javascript" src="javascripts/music_generator.js"></script>

  <script type="text/javascript">
    syntaxhighlighterConfig = {
      autoLinks: false,
    };

    $(guidesIndex.bind);

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-115746206-1');
  </script>

  <script type="text/javascript">
    var locationId = (location.pathname).split("/").pop().substring(0, 49);

    if (locationId) {
      var language = window.location.search.match("lang=en") ? "en" : "zh-CN"

      if (window.location.href.match("github")) {
        var gitalk = new Gitalk({
          clientID: '85c5f833b04d6d470db9',
          clientSecret: 'b41619fc891132558550103056197eb30baebab5',
          repo: 'blog-github-page-comments',
          owner: 'dengqinghua',
          admin: ['dengqinghua'],
          id: locationId,
          distractionFreeMode: true,
          language: language
        });
      } else {
        var gitalk = new Gitalk({
          clientID: '0f5824fe1c09851e9781',
          clientSecret: '61710a77ee98cddce06f408a398f05c8622e9575',
          repo: 'blog_comments',
          owner: 'dengqinghua',
          admin: ['dengqinghua'],
          id: locationId,
          distractionFreeMode: true,
          language: language
        });
      }

      gitalk.render('comment');
    }
  </script>
</body>
</html>
