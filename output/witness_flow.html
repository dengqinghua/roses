<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="baidu-site-verification" content="N1Q3HiESgp" />

<title>业务流引擎系统 — dengqinghua&#39;s blog</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
  <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shCore.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shThemeRailsGuides.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/fixes.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/abcjs-midi.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/gitalk.css" />
  <link rel="stylesheet" type="text/css" href="stylesheets/Treant.css" />
  <link href="images/favicon.jpeg" rel="shortcut icon" type="image/x-icon" />
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="guide">
  <div id="topNav">
    <div class="wrapper">

      <strong class="more-info-label">More:</strong>

      <span class="red-button more-info-button">More Dengqinghua</span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://dengqinghua.github.io/about_me.html">About me</a></li>
        <li class="more-info"><a href="https://github.com/dengqinghua/">Github</a></li>
        <li class="more-info"><a href="mailto:dengqinghua.42@gmail.com">Gmail</a></li>
        <li class="more-info"><a href="https://twitter.com/dengqinghua_42">Twitter</a></li>
      </ul>

      <form action="https://google.com/search" method="get">
          <input name="q" value="site:dengqinghua.github.io" type="hidden">
          <input class="search" name="q" placeholder="Search Blog" type="text">
      </form>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="http://dengqinghua.github.io" title="Return to home page">http://dengqinghua.github.io</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="http://dengqinghua.github.io">Home</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">
            Index <span id="guidesArrow">▸</span>
          </a>

          <div id="guides" class="clearfix" style="display: none;">
            <hr />
              <dl class="L">
                <dt>推荐</dt>
                <dd><a href="badge_system.html">基于内存数据库的角标系统设计</a></dd>
                <dd><a href="witness_flow.html">业务流引擎系统</a></dd>
                <dt>Ruby</dt>
                <dd><a href="ruby_knowledge_tree.html">Ruby知识树</a></dd>
                <dd><a href="ruby_model.html">Ruby数据模型</a></dd>
                <dd><a href="arel.html?lang=en">Arel源码分析</a></dd>
                <dd><a href="sidekiq_task_event.html">基于Sidekiq的异步任务管理引擎</a></dd>
                <dd><a href="racc.html">Racc</a></dd>
                <dd><a href="witness_flow.html">业务流引擎系统</a></dd>
                <dt>Java</dt>
                <dd><a href="data_structures.html">数据结构</a></dd>
                <dd><a href="learn_jvm.html">JVM剖析</a></dd>
                <dd><a href="concurrency.html">Concurrency</a></dd>
                <dd><a href="badge_system.html">基于内存数据库的角标系统设计</a></dd>
                <dd><a href="maven_under_command_line.html">命令行下的Maven</a></dd>
                <dt>MySQL</dt>
                <dd><a href="mysql_knowledge_tree.html">MySQL知识树</a></dd>
              </dl>
              <dl class="R">
                <dt>Go</dt>
                <dd><a href="go_get_timeout_solution.html">GoInstallBinaries i/o timeout问题</a></dd>
                <dd><a href="go_knowledge_tree.html">Go知识树</a></dd>
                <dt>音乐</dt>
                <dd><a href="music_index.html">音乐学习体系</a></dd>
                <dd><a href="lalaland-city_of_stars.html">City Of Star</a></dd>
                <dd><a href="あの日の帰り道.html">あの日の帰り道</a></dd>
                <dd><a href="rain_wwh.html">雨の日はワルツを踊って</a></dd>
                <dd><a href="moon_river.html">Moon River</a></dd>
                <dd><a href="it_could_have_been.html">Es Ware Schon Gewesen</a></dd>
                <dt>杂记</dt>
                <dd><a href="example_markdown.html">markdown格式实例</a></dd>
                <dd><a href="comments.html">注释规范</a></dd>
                <dd><a href="best_programming.html">零bug落地方案</a></dd>
                <dd><a href="raft.html">Raft算法</a></dd>
                <dd><a href="memorize_my_mentor.html">Memorize My Mentor</a></dd>
              </dl>
          </div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Index</option>
              <optgroup label="推荐">
                  <option value="badge_system.html">基于内存数据库的角标系统设计</option>
                  <option value="witness_flow.html">业务流引擎系统</option>
              </optgroup>
              <optgroup label="Ruby">
                  <option value="ruby_knowledge_tree.html">Ruby知识树</option>
                  <option value="ruby_model.html">Ruby数据模型</option>
                  <option value="arel.html?lang=en">Arel源码分析</option>
                  <option value="sidekiq_task_event.html">基于Sidekiq的异步任务管理引擎</option>
                  <option value="racc.html">Racc</option>
                  <option value="witness_flow.html">业务流引擎系统</option>
              </optgroup>
              <optgroup label="Java">
                  <option value="data_structures.html">数据结构</option>
                  <option value="learn_jvm.html">JVM剖析</option>
                  <option value="concurrency.html">Concurrency</option>
                  <option value="badge_system.html">基于内存数据库的角标系统设计</option>
                  <option value="maven_under_command_line.html">命令行下的Maven</option>
              </optgroup>
              <optgroup label="MySQL">
                  <option value="mysql_knowledge_tree.html">MySQL知识树</option>
              </optgroup>
              <optgroup label="Go">
                  <option value="go_get_timeout_solution.html">GoInstallBinaries i/o timeout问题</option>
                  <option value="go_knowledge_tree.html">Go知识树</option>
              </optgroup>
              <optgroup label="音乐">
                  <option value="music_index.html">音乐学习体系</option>
                  <option value="lalaland-city_of_stars.html">City Of Star</option>
                  <option value="あの日の帰り道.html">あの日の帰り道</option>
                  <option value="rain_wwh.html">雨の日はワルツを踊って</option>
                  <option value="moon_river.html">Moon River</option>
                  <option value="it_could_have_been.html">Es Ware Schon Gewesen</option>
              </optgroup>
              <optgroup label="杂记">
                  <option value="example_markdown.html">markdown格式实例</option>
                  <option value="comments.html">注释规范</option>
                  <option value="best_programming.html">零bug落地方案</option>
                  <option value="raft.html">Raft算法</option>
                  <option value="memorize_my_mentor.html">Memorize My Mentor</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>业务流引擎系统</h2><div class="date"><p>2017-07-03</p></div><p>随着系统的日益演进, 系统的业务逻辑非常复杂, 尤其是在产品需求频繁变动的情况下, 研发需要不断地进行改动代码, 最终逻辑无人知晓.</p><p>为了让核心业务逻辑更清晰, 更快速地响应业务的变更, 我们研发了业务流引擎系统. 通过 &quot;代码 + 流程图配置&quot; 的方式, 将业务的复杂度变为引擎实现的技术难度.</p><p>该文档涵盖业务流引擎的使用和设计.</p><p>阅读完该文档后，您将会了解到下面这些内容:</p>
<ul>
<li>为什么引入业务流引擎.</li>
<li>业务流引擎的适用范围.</li>
<li>业务流引擎的设计.</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li>
<a href="#%E5%BC%95%E6%93%8E%E7%94%B1%E6%9D%A5">引擎由来</a>

<ul>
<li><a href="#%E8%B5%B7%E5%9B%A0">起因</a></li>
<li><a href="#%E5%BC%95%E6%93%8E%E9%85%8D%E7%BD%AE">引擎配置</a></li>
<li><a href="#%E5%8E%9F%E6%9C%89%E6%8A%A5%E5%90%8D%E9%80%BB%E8%BE%91%E9%87%8D%E6%9E%84">原有报名逻辑重构</a></li>
<li><a href="#%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C%E5%8F%AF%E8%A7%86%E5%8C%96">执行结果可视化</a></li>
</ul>
</li>
<li>
<a href="#%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1">架构设计</a>

<ul>
<li><a href="#runner">Runner</a></li>
<li><a href="#ast-definition">AST Definition</a></li>
<li><a href="#vistor">Vistor</a></li>
<li><a href="#inform">Inform</a></li>
</ul>
</li>
<li>
<a href="#%E4%BC%98%E7%BC%BA%E7%82%B9%E5%88%86%E6%9E%90">优缺点分析</a>

<ul>
<li><a href="#%E4%BC%98%E7%82%B9">优点</a></li>
<li><a href="#%E7%BC%BA%E7%82%B9">缺点</a></li>
</ul>
</li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="引擎由来"><a class="anchorlink" href="#%E5%BC%95%E6%93%8E%E7%94%B1%E6%9D%A5">1 引擎由来</a></h3><h4 id="起因"><a class="anchorlink" href="#%E8%B5%B7%E5%9B%A0">1.1 起因</a></h4>
<ol>
<li>产品需求更改频繁</li>
<li>经常新增, 去除业务功能</li>
<li>核心业务逻辑变动频繁, 最终逻辑无人知晓</li>
</ol>
<p>下面是一次产品业务逻辑的PRD文档</p><p><img src="https://raw.githubusercontent.com/dengqinghua/roses/master/assets/images/prd_complex_example.png" alt="complex_example"></p><p>上述逻辑非常复杂, 每一个分支又有自己独立的逻辑, 再经过几次需求的变动, 最终报名的逻辑无人知晓,
只能通过研发去从代码中找逻辑, 出现的bug也很难排查.</p><p>基于上述痛点, 我们研发了<code>业务流引擎</code>, 它主要解决下面几个问题</p>
<ul>
<li>流程配置可视化, 流程图即是代码</li>
<li>每一个流程的执行过程可视化</li>
</ul>
<div class="info"><p>该引擎的设计参考了 Netflix的微服务编排工具<a href="https://netflix.github.io/conductor/">Conductor</a> 和 美团的<a href="https://tech.meituan.com/maze-framework.html">从0到1：构建强大且易用的规则引擎</a></p></div><h4 id="引擎配置"><a class="anchorlink" href="#%E5%BC%95%E6%93%8E%E9%85%8D%E7%BD%AE">1.2 引擎配置</a></h4><p>下面是我们业务流引擎系统的一个的配置图:</p><p><img src="https://raw.githubusercontent.com/dengqinghua/roses/master/assets/images/complex_example.png" alt="flow_exmaple"></p><p>每一个配置项都包括下面几个参数</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>释义</th>
</tr>
</thead>
<tbody>
<tr>
<td>method_call</td>
<td>方法调用函数</td>
</tr>
<tr>
<td>output</td>
<td>输出参数</td>
</tr>
<tr>
<td>touch</td>
<td>是否支持重试</td>
</tr>
</tbody>
</table>
<p>由上图可以看到: 我们将一个复杂的业务流<code>强制</code>拆解为一个一个的方法,
并将方法通过拖拽的形式进行组装, 形成一个完整的业务流程.</p><h4 id="原有报名逻辑重构"><a class="anchorlink" href="#%E5%8E%9F%E6%9C%89%E6%8A%A5%E5%90%8D%E9%80%BB%E8%BE%91%E9%87%8D%E6%9E%84">1.3 原有报名逻辑重构</a></h4><p>原有报名逻辑如下:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
 42         ##
 43         # ==== Description
 44         #   创建报名记录
 45         #
 49         def create_candidate_deal(params_hash)
 50           logger.info("传入参数: #{params_hash} at: #{Time.now.to_s(:db)}")
 51
 52           candidate_deal = ::CandidateDeal.new
 53           candidate_deal.assign_attributes(params_hash['candidate_deal'])

 ...

211
212           if candidate_deal.zhe_trade?
213             ProductClient.submit(current_shop, [candidate_deal.product_id])
214           end
215
216           logger.info("传入参数: #{params_hash} 报名流程结束")
217         end

</pre>
</div>
<p>我们可以看到, 代码从42行一直到217, <code>create_candidate_deal</code> 这个方法做了很多事情, 因为流程的复杂,
很容易产生 <code>Fat Method</code>, 各种 <code>If Else</code> 嵌套逻辑, 代码变得难以测难和维护.</p><h5 id="流程引擎改造"><a class="anchorlink" href="#%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E6%94%B9%E9%80%A0">1.3.1 流程引擎改造</a></h5>
<ol>
<li>
<p>配置流程图名称</p>
<p><img src="https://raw.githubusercontent.com/dengqinghua/roses/master/assets/images/setting_flow_name.png" alt="setting_flow_name"></p>
<p>如上图所示, 整个流程配置了两个字段</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
name: 报名流程
version: 3

</pre>
</div>
<p>这两个字段确定了一个唯一的业务流程图.</p>
</li>
<li>
<p>引擎接管逻辑运行</p>
<p>通过配置流程名称和版本号 <code>name: "报名流程", version: 3</code>, 即可获取到整个流程配置.</p>
<p>原有的复杂的一百多行报名逻辑的代码可以简化为不到10行的代码:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: true;">
def create_candidate_deal_by_witness(params_hash)
  witness = { name: "报名流程", version: 3 },  # 配置 流程名称 和 版本号
  runner  = ::Witness::Ast::Runner.new(
    witness: witness,
    params: params_hash
  )
  result = runner.run # 执行run方法, 即可运行整个流程图

  if result[:status] == :error
    raise result[:message].to_s
  end
end

</pre>
</div>
</li>
</ol>
<h4 id="执行结果可视化"><a class="anchorlink" href="#%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C%E5%8F%AF%E8%A7%86%E5%8C%96">1.4 执行结果可视化</a></h4><p><img src="https://raw.githubusercontent.com/dengqinghua/roses/master/assets/images/running_result.png" alt="runners"></p><p>从上图可以看到, 每一个运行步骤都是可视化的, 包括下面这些参数</p>
<ul>
<li>开始执行时间</li>
<li>结束执行时间</li>
<li>调用方法体</li>
<li>参数</li>
<li>返回结果</li>
</ul>
<p>从上面的参数可以很方便得看到每一次流程运行的整个过程</p><h5 id="可视化产生的性能问题"><a class="anchorlink" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E4%BA%A7%E7%94%9F%E7%9A%84%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98">1.4.1 可视化产生的性能问题</a></h5>
<ol>
<li>
<p>时间维度的性能问题</p>
<p>由于所有的信息都是推送到<code>kafka</code>异步处理的, 推送消息的时间基本稳定在1ms左右, 最复杂的业务流大概包括20个步骤, 故性能的损耗大概为20ms, 该部分的时间对于整个报名系统而言, 影响基本可以忽略不计.</p>
</li>
<li>
<p>存储空间问题</p>
<p>由于记录了每一次运行的结果, 为了更好地扩展参数, 我们将整个上下文都存储到了<code>ES</code>, 会占用非常大的存储空间, 经过估算后, 我们仅保留一周的数据. 1周之前的数据将进行定时删除.</p>
</li>
</ol>
<h3 id="架构设计"><a class="anchorlink" href="#%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1">2 架构设计</a></h3><p><img src="https://raw.githubusercontent.com/dengqinghua/roses/master/assets/images/witness_structure.png" alt="架构图"></p><h4 id="runner"><a class="anchorlink" href="#runner">2.1 Runner</a></h4><p>执行引擎, 该部分接收流程图配置信息和对应的参数, 负责执行业务流程图的代码.</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: true;">
runner = Witness::Ast::Runner.new(witness: Witness::Zhaoshang::Example, params: {})
runner.run

</pre>
</div>
<h4 id="ast-definition"><a class="anchorlink" href="#ast-definition">2.2 AST Definition</a></h4><p>生成一个执行树, 包含了整个流程图的信息</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: true;">
Witness::Ast::Node.new(definition)

</pre>
</div>
<h4 id="vistor"><a class="anchorlink" href="#vistor">2.3 Vistor</a></h4><p>通过<code>Vistor</code>对执行树进行遍历</p><p>该部分参考了Rails源码中<a href="http://blog.dengqinghua.net/arel.html">Arel的设计</a>, 按照深度优先的方式遍历AST树, 每一个<code>Vistor</code>都有不同的作用实体,
分别执行不同的任务.</p><p>项目中用到的<code>Visitor</code>如下:</p>
<table>
<thead>
<tr>
<th>VistorType</th>
<th>释义</th>
</tr>
</thead>
<tbody>
<tr>
<td>CallVisitor</td>
<td>执行引擎</td>
</tr>
<tr>
<td>MethodValidationVisitor</td>
<td>方法合法性校验引擎</td>
</tr>
<tr>
<td>SVGGeneratorVisitor</td>
<td>SVG生成器,生成最终的可视化流程图</td>
</tr>
</tbody>
</table>
<h4 id="inform"><a class="anchorlink" href="#inform">2.4 Inform</a></h4><p>所有的流程执行上下文都推入了 <code>Kafka</code> 队列, 最终数据落地至 <code>ElasticSearch</code>.</p><h3 id="优缺点分析"><a class="anchorlink" href="#%E4%BC%98%E7%BC%BA%E7%82%B9%E5%88%86%E6%9E%90">3 优缺点分析</a></h3><h4 id="优点"><a class="anchorlink" href="#%E4%BC%98%E7%82%B9">3.1 优点</a></h4>
<ol>
<li>业务流更加清晰, 任何人都可以对业务流引擎进行修改和维护</li>
<li>强制将现在的<code>Fat Method</code>变为<code>Tiny Method</code>, 更容易进行单元测试和黑盒测试</li>
<li>可以提前进行架构设计, 书写伪代码</li>
</ol>
<h4 id="缺点"><a class="anchorlink" href="#%E7%BC%BA%E7%82%B9">3.2 缺点</a></h4>
<ol>
<li>和传统的写代码的思维方式不同</li>
<li>方法的调用是在数据库中的, 会出现很多方法在项目中找不到调用的地方</li>
<li>业务流过于复杂之后, 编排本身变成一个耗时的事情</li>
</ol>


        <div id="comment"></div>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>版权声明：自由转载-非商用-非衍生-保持署名(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>)</p>
<p>
  <a href="https://github.com/996icu/996.ICU/blob/master/LICENSE"><img src="https://img.shields.io/badge/license-Anti%20996-blue.svg" /></a>
</p>

    </div>
  </div>

  <script type="text/javascript" src="javascripts/jquery.min.js"></script>
  <script type="text/javascript" src="javascripts/responsive-tables.js"></script>
  <script type="text/javascript" src="javascripts/guides.js"></script>
  <script type="text/javascript" src="javascripts/acoustic_grand_piano-ogg.js"></script>

  <!-- ./node_modules/gulp/bin/gulp.js build -\-brushes=bash,cpp,css,javascript,java,plain,python,ruby,scala,sql,xml -->
  <!-- uglifyjs syntaxhighlighter.js  -\-output syntaxhighlighter.min.js -->
  <script type="text/javascript" src="javascripts/syntaxhighlighter.min.js"></script>
  <script type="text/javascript" src="javascripts/tonal.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"></script> -->
  <script type="text/javascript" src="javascripts/Tone.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.4/svg.min.js"></script> -->
  <script type="text/javascript" src="javascripts/svg.min.js"></script>
  <script type="text/javascript" src="javascripts/chordy-svg.min.js"></script>
  <script type="text/javascript" src="javascripts/chord.js"></script>
  <!-- <script type="text/javascript" src="javascripts/gitalk.min.js"></script> -->
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.2.2/gitalk.min.js"></script> -->
  <script type="text/javascript" src="javascripts/gitalk.min.js"></script>
  <script type="text/javascript" src="javascripts/load_docs.js"></script>
  <script type="text/javascript" src="javascripts/Treant.js"></script>
  <!-- <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.0/raphael&#45;min.js"></script> -->
  <script type="text/javascript" src="javascripts/raphael.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.11.0/flowchart.min.js"></script> -->
  <script type="text/javascript" src="javascripts/flowchart.min.js"></script>
  <script type="text/javascript" src="javascripts/flowchart_generator.js"></script>
  <script type="text/javascript" src="javascripts/tree_generator.js"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-115746206-1"></script>

  <script type="text/javascript" src="javascripts/abcjs_midi_5.1.2-min.js"></script>
  <script type="text/javascript" src="javascripts/music_generator.js"></script>

  <script type="text/javascript">
    syntaxhighlighterConfig = {
      autoLinks: false,
    };

    $(guidesIndex.bind);

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-115746206-1');
  </script>

  <script type="text/javascript">
    var locationId = (location.pathname).split("/").pop().substring(0, 49);

    if (locationId) {
      var language = window.location.search.match("lang=en") ? "en" : "zh-CN"

      if (window.location.href.match("github")) {
        var gitalk = new Gitalk({
          clientID: '85c5f833b04d6d470db9',
          clientSecret: 'b41619fc891132558550103056197eb30baebab5',
          repo: 'blog-github-page-comments',
          owner: 'dengqinghua',
          admin: ['dengqinghua'],
          id: locationId,
          distractionFreeMode: true,
          language: language
        });
      } else {
        var gitalk = new Gitalk({
          clientID: '0f5824fe1c09851e9781',
          clientSecret: '61710a77ee98cddce06f408a398f05c8622e9575',
          repo: 'blog_comments',
          owner: 'dengqinghua',
          admin: ['dengqinghua'],
          id: locationId,
          distractionFreeMode: true,
          language: language
        });
      }

      gitalk.render('comment');
    }
  </script>
</body>
</html>
